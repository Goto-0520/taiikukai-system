<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åƒè‘‰å·¥æ¥­å¤§å­¦ ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans JP', sans-serif; }
    html, body { height: 100%; background: #fff; }
    .dept-card { background:#fff; transition:all 0.3s; cursor:pointer; }
    .dept-card:hover { transform:translateY(-4px); box-shadow:0 20px 40px rgba(0,0,0,.1); }
    .dept-card-secretary { border:3px solid #1e3a5f; }
    .dept-card-finance    { border:3px solid #f59e0b; }
    .dept-card-general    { border:3px solid #1f2937; }
    .dept-card-external   { border:3px solid #f97316; }
    .dept-card-editorial  { border:3px solid #ec4899; }
    .dept-card-event      { border:3px solid #06b6d4; }
    .dept-card-admin      { border:3px solid #6b7280; }
    .btn-sec  { background:linear-gradient(135deg,#1e3a5f,#0f1f3c); color:#fff; transition:all .2s; }
    .btn-fin  { background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; transition:all .2s; }
    .btn-gen  { background:linear-gradient(135deg,#1f2937,#111827); color:#fff; transition:all .2s; }
    .btn-ext  { background:linear-gradient(135deg,#f97316,#ea580c); color:#fff; transition:all .2s; }
    .btn-edi  { background:linear-gradient(135deg,#ec4899,#db2777); color:#fff; transition:all .2s; }
    .btn-pri  { background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; transition:all .2s; }
    .btn-sec:hover,.btn-fin:hover,.btn-gen:hover,.btn-ext:hover,.btn-edi:hover,.btn-pri:hover { transform:scale(1.02); filter:brightness(.9); }
    .btn-gray { background:#e5e7eb; color:#374151; transition:all .2s; }
    .btn-gray:hover { background:#d1d5db; }
    .fade-in { animation:fadeIn .4s ease-out; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .data-table { border-collapse:collapse; width:100%; }
    .data-table th { background:#f3f4f6; border:1px solid #d1d5db; padding:10px 14px; font-weight:600; color:#1f2937; white-space:nowrap; }
    .data-table td { border:1px solid #d1d5db; padding:10px 14px; color:#374151; }
    .data-table tr:hover td { background:#f9fafb; }
    .inp { background:#fff; border:1px solid #d1d5db; color:#1f2937; transition:border-color .2s; }
    .inp:focus { border-color:#3b82f6; outline:none; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .modal-bg { background:rgba(0,0,0,.5); backdrop-filter:blur(4px); }
    .doc-btn { padding:10px 16px; border-radius:8px; font-weight:500; transition:all .2s; cursor:pointer; border:1px solid #d1d5db; }
    .doc-btn.active { background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .doc-btn.inactive { background:#f3f4f6; color:#6b7280; }
    .ms-con { border:1px solid #d1d5db; border-radius:8px; background:#fff; max-height:200px; overflow-y:auto; }
    .ms-item { padding:10px 12px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; gap:10px; }
    .ms-item:hover { background:#f9fafb; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid #3b82f6; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    .ai-card { border:2px solid #e5e7eb; border-radius:12px; padding:16px; background:#fff; }
    .ai-card.warn { border-color:#f97316; background:#fff7ed; }
    .cf-hi{color:#16a34a} .cf-md{color:#d97706} .cf-lo{color:#dc2626}
    .row-unreturned { background:#fef9c3 !important; }
    .row-returned   { background:#dcfce7 !important; }
  </style>
</head>
<body class="h-full bg-white text-gray-900 flex flex-col overflow-hidden">
<div class="h-full flex flex-col">

<!-- Header -->
<header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
  <div class="flex items-center gap-4">
    <button id="backBtn" class="hidden btn-gray px-4 py-2 rounded-lg text-sm" onclick="navigateTo('home')">â† ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    <h1 id="pageTitle" class="text-xl font-semibold text-gray-900">ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
  </div>
  <div class="flex items-center gap-3">
    <span id="gasStatus" class="text-xs text-gray-500">â— æ¥ç¶šç¢ºèªä¸­...</span>
  </div>
</header>

<main class="flex-1 overflow-auto px-6 py-6">

<!-- ========== HOME ========== -->
<div id="homeScreen" class="fade-in">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold mb-3 text-gray-900">åƒè‘‰å·¥æ¥­å¤§å­¦ ä½“è‚²ä¼šæœ¬éƒ¨</h2>
      <p class="text-gray-600">37ã‚¯ãƒ©ãƒ–ã‚’çµ±æ‹¬ã™ã‚‹æ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <button class="dept-card dept-card-secretary rounded-2xl p-6 text-left" onclick="navigateTo('secretary')"><h3 class="text-lg font-semibold mb-2">ğŸ“ æ›¸è¨˜éƒ¨</h3><p class="text-sm text-gray-600">æ–½è¨­äºˆç´„ç®¡ç†ãƒ»å€Ÿç”¨å±Šå‡¦ç†</p></button>
      <button class="dept-card dept-card-finance    rounded-2xl p-6 text-left" onclick="navigateTo('finance')"><h3 class="text-lg font-semibold mb-2">ğŸ’° è²¡å‹™éƒ¨</h3><p class="text-sm text-gray-600">å‡ºç´å¸³ç®¡ç†ãƒ»äºˆç®—ç®¡ç†</p></button>
      <button class="dept-card dept-card-general    rounded-2xl p-6 text-left" onclick="navigateTo('general')"><h3 class="text-lg font-semibold mb-2">ğŸ“Š ç·å‹™éƒ¨</h3><p class="text-sm text-gray-600">å‡ºæ¬ ç®¡ç†ãƒ»çµ±è¨ˆåˆ†æ</p></button>
      <button class="dept-card dept-card-external   rounded-2xl p-6 text-left" onclick="navigateTo('external')"><h3 class="text-lg font-semibold mb-2">ğŸ”— æ¸‰å¤–éƒ¨</h3><p class="text-sm text-gray-600">èª²å¤–æ´»å‹•å±Šãƒ»æ´»å‹•å ±å‘Šæ›¸</p></button>
      <button class="dept-card dept-card-editorial  rounded-2xl p-6 text-left" onclick="navigateTo('editorial')"><h3 class="text-lg font-semibold mb-2">âœï¸ ç·¨é›†éƒ¨</h3><p class="text-sm text-gray-600">å›£ä½“DBç®¡ç†ãƒ»åç°¿æ ¡æ­£</p></button>
      <button class="dept-card dept-card-event      rounded-2xl p-6 text-left" onclick="navigateTo('event')"><h3 class="text-lg font-semibold mb-2">ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h3><p class="text-sm text-gray-600">å‚åŠ ç®¡ç†ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</p></button>
    </div>
    <div class="flex justify-center">
      <button class="dept-card dept-card-admin rounded-xl px-8 py-4 text-left" onclick="navigateTo('admin')">
        <h3 class="font-semibold">ğŸ”’ ç®¡ç† &amp; è¨­å®š</h3>
        <p class="text-xs text-gray-500">ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ»æ¨©é™ç®¡ç†</p>
      </button>
    </div>
  </div>
</div>

<!-- ========== æ›¸è¨˜éƒ¨ ========== -->
<div id="secretaryScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">æ›¸è¨˜éƒ¨ - æ–½è¨­äºˆç´„ç®¡ç†</h2>
      <!-- PDFé¸æŠãƒ»AIèª­å– -->
      <div class="bg-blue-50 rounded-xl p-6 mb-6 border border-blue-200">
        <h3 class="font-medium mb-4">ğŸ“„ å€Ÿç”¨å±ŠPDFã‚’é¸æŠã—ã¦AIèª­å–</h3>
        <input type="file" id="secPdfInput" accept=".pdf,image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-100 file:text-blue-700 mb-3">
        <div class="flex gap-3 flex-wrap items-center">
          <button class="btn-sec px-6 py-3 rounded-lg font-medium" onclick="analyzeDoc('secretary')">ğŸ¤– AIèª­å–é–‹å§‹</button>
          <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
            <input type="checkbox" id="secTestMode"> âš™ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆGASæœªé€ä¿¡ï¼‰
          </label>
        </div>
      </div>
      <!-- AIçµæœã‚«ãƒ¼ãƒ‰ -->
      <div id="secAiResults" class="space-y-4 mb-6"></div>
      <!-- æ‰‹å‹•å…¥åŠ› -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“‹ æ–½è¨­ä½¿ç”¨é¡˜ã‚’è¨˜éŒ²</h3>
          <div class="space-y-3 mb-4">
            <div><label class="block text-xs text-gray-600 mb-1">æ–½è¨­</label>
              <select id="secFacility" class="inp w-full px-4 py-2 rounded-lg" onchange="handleFacilityChange()">
                <option value="">é¸æŠ</option>
                <option>ä½“è‚²é¤¨</option><option>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ«ãƒ¼ãƒ </option><option>é™¸ä¸Šç«¶æŠ€å ´</option>
                <option>é‡çƒå ´</option><option>ãƒ“ãƒ¼ãƒãƒãƒ¬ãƒ¼</option><option>ãƒãƒ³ãƒ‰ãƒœãƒ¼ãƒ«ã‚³ãƒ¼ãƒˆ</option>
                <option>ãƒ†ãƒ‹ã‚¹ã‚³ãƒ¼ãƒˆ</option><option>ãƒ©ã‚°ãƒ“ãƒ¼å ´</option><option>ã‚µãƒƒã‚«ãƒ¼å ´</option>
                <option>æ­¦é“é¤¨ï¼ˆå‰£é“å ´ãƒ»æŸ”é“å ´ï¼‰</option><option>å¤šç›®çš„ãƒ«ãƒ¼ãƒ </option>
                <option>æ­¦é“å ´ï¼ˆç©ºæ‰‹é“å ´ï¼‰</option><option>éƒ¨å®¤æ£Ÿä¼šè­°å®¤</option>
                <option>å°„æ’ƒå ´</option><option>å¼“é“å ´</option><option>å±‹å†…ç·´ç¿’å ´</option>
                <option>æ–°ç¿’å¿—é‡é‡çƒå ´</option><option value="æ–°è¦è¿½åŠ ">â• æ–°è¦è¿½åŠ </option>
              </select>
            </div>
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label>
              <select id="secClub" class="inp w-full px-4 py-2 rounded-lg"></select>
            </div>
            <div><label class="block text-xs text-gray-600 mb-1">æ—¥ä»˜</label>
              <input type="date" id="secDate" class="inp w-full px-4 py-2 rounded-lg">
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-xs text-gray-600 mb-1">é–‹å§‹</label><input type="time" id="secStart" class="inp w-full px-4 py-2 rounded-lg"></div>
              <div><label class="block text-xs text-gray-600 mb-1">çµ‚äº†</label><input type="time" id="secEnd" class="inp w-full px-4 py-2 rounded-lg"></div>
            </div>
          </div>
          <button class="btn-sec w-full px-5 py-3 rounded-lg font-medium" onclick="saveSecEntry()">âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²</button>
        </div>
        <div class="bg-orange-50 rounded-xl p-6 border border-orange-200">
          <h3 class="font-medium mb-3">ğŸ“ æœ¬æ—¥ã®è¨˜éŒ²</h3>
          <div id="secSavedList" class="space-y-2 max-h-64 overflow-y-auto"><p class="text-sm text-gray-500">è¨˜éŒ²ãªã—</p></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== è²¡å‹™éƒ¨ ========== -->
<div id="financeScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">è²¡å‹™éƒ¨ - å‡ºç´å¸³ç®¡ç†</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200"><p class="text-sm text-emerald-700 mb-1">æ‰‹è¨±ç¾é‡‘</p><p id="finCash" class="text-2xl font-bold text-emerald-900">Â¥0</p></div>
        <div class="bg-blue-50 rounded-xl p-4 border border-blue-200"><p class="text-sm text-blue-700 mb-1">é€šå¸³æ®‹é«˜</p><p id="finBank" class="text-2xl font-bold text-blue-900">Â¥0</p></div>
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200"><p class="text-sm text-gray-700 mb-1">åˆè¨ˆæ®‹é«˜</p><p id="finTotal" class="text-2xl font-bold text-gray-900">Â¥0</p></div>
      </div>
      <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
        <h3 class="font-medium mb-4">æ–°è¦å–å¼•å…¥åŠ›</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div><label class="block text-xs text-gray-600 mb-1">æ—¥ä»˜</label><input type="date" id="finDate" class="inp w-full px-4 py-2 rounded-lg"></div>
          <div><label class="block text-xs text-gray-600 mb-1">è¡Œäº‹ãƒ»ç§‘ç›®</label>
            <div class="flex gap-2">
              <select id="finSubj" class="inp flex-1 px-4 py-2 rounded-lg"></select>
              <button onclick="addFinSubj()" class="btn-gray px-3 py-2 rounded-lg text-sm" title="ç§‘ç›®è¿½åŠ ">+</button>
            </div>
          </div>
          <div><label class="block text-xs text-gray-600 mb-1">æ‘˜è¦</label><input type="text" id="finMemo" class="inp w-full px-4 py-2 rounded-lg" placeholder="å†…å®¹ã‚’å…¥åŠ›"></div>
          <div><label class="block text-xs text-gray-600 mb-1">æ”¯æ‰•æ–¹æ³•</label>
            <div class="flex gap-4 mt-2">
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finPay" value="ç¾é‡‘" checked><span class="text-sm">ç¾é‡‘</span></label>
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finPay" value="é€šå¸³"><span class="text-sm">é€šå¸³</span></label>
            </div>
          </div>
          <div><label class="block text-xs text-gray-600 mb-1">åå…¥ï¼ˆå††ï¼‰</label><input type="number" id="finIncome" class="inp w-full px-4 py-2 rounded-lg" placeholder="0" min="0"></div>
          <div><label class="block text-xs text-gray-600 mb-1">æ”¯å‡ºï¼ˆå††ï¼‰</label><input type="number" id="finExpense" class="inp w-full px-4 py-2 rounded-lg" placeholder="0" min="0"></div>
        </div>
        <div class="flex items-center gap-6 mb-4">
          <span class="text-xs text-gray-600">ç«‹æ›¿çŠ¶æ…‹</span>
          <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finRepl" value="/" checked><span class="text-sm">/</span></label>
          <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finRepl" value="æœªè¿”é‡‘"><span class="text-sm">æœªè¿”é‡‘</span></label>
          <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finRepl" value="è¿”é‡‘æ¸ˆ"><span class="text-sm">è¿”é‡‘æ¸ˆ</span></label>
        </div>
        <button class="btn-fin px-6 py-3 rounded-lg font-medium" onclick="addFinEntry()">â• è¿½åŠ </button>
      </div>
      <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200 mb-4">
        <div class="overflow-x-auto max-h-72">
          <table class="data-table text-sm">
            <thead><tr><th>æ—¥ä»˜</th><th>ç§‘ç›®</th><th>æ‘˜è¦</th><th>æ”¯æ‰•</th><th>åå…¥</th><th>æ”¯å‡º</th><th>ç«‹æ›¿</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="finBody"><tr><td colspan="8" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="flex gap-3 flex-wrap">
        <button class="btn-pri px-5 py-3 rounded-xl font-bold" onclick="exportFinance('monthly')">ğŸ“¥ æœˆåˆ¥Excelå‡ºåŠ›</button>
        <button class="px-5 py-3 rounded-xl font-bold text-white" style="background:linear-gradient(135deg,#7c3aed,#5b21b6)" onclick="exportFinance('yearly')">ğŸ“¥ å¹´åº¦æœ«Excelå‡ºåŠ›</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== ç·å‹™éƒ¨ ========== -->
<div id="generalScreen" class="hidden fade-in">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ç·å‹™éƒ¨ - å‡ºæ¬ ç®¡ç†ãƒ»çµ±è¨ˆ</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="space-y-6">
          <!-- å­¦æœŸé¸æŠ -->
          <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
            <h3 class="font-medium mb-4">ğŸ“… å­¦æœŸé¸æŠ</h3>
            <select id="genTerm" class="inp w-full px-4 py-2 rounded-lg">
              <option>å‰æœŸ (4æœˆã€œ7æœˆ)</option><option>å¤å­£ä¼‘æ¥­ ç¬¬1é€±</option><option>å¤å­£ä¼‘æ¥­ ç¬¬2é€±</option><option>å¤å­£ä¼‘æ¥­ ç¬¬3é€±</option>
              <option>å¾ŒæœŸ (9æœˆã€œ12æœˆ)</option><option>å†¬å­£ä¼‘æ¥­ ç¬¬1é€±</option><option>å†¬å­£ä¼‘æ¥­ ç¬¬2é€±</option><option>å†¬å­£ä¼‘æ¥­ ç¬¬3é€±</option>
            </select>
          </div>
          <!-- æ›œæ—¥æ‹…å½“è¨­å®š -->
          <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
            <h3 class="font-medium mb-4">ğŸ‘¥ æ›œæ—¥æ‹…å½“è¨­å®š</h3>
            <div class="mb-3"><label class="block text-xs text-gray-600 mb-1">æ›œæ—¥ã‚’é¸æŠ</label>
              <select id="genWeekday" class="inp w-full px-4 py-2 rounded-lg">
                <option value="">é¸æŠ</option><option>æœˆ</option><option>ç«</option><option>æ°´</option><option>æœ¨</option><option>é‡‘</option><option>åœŸ</option><option>æ—¥</option>
              </select>
            </div>
            <div class="mb-3"><label class="block text-xs text-gray-600 mb-1">æ‹…å½“éƒ¨å“¡ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <div class="ms-con" id="genWeekdayMembers"><div class="text-gray-500 text-sm p-4">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>
            <button class="btn-gen w-full px-4 py-2 rounded-lg" onclick="saveWeekday()">è¨­å®šã‚’ä¿å­˜</button>
          </div>
          <!-- å‡ºæ¬ è¨˜éŒ² -->
          <div class="bg-emerald-50 rounded-xl p-6 border border-emerald-200">
            <h3 class="font-medium mb-4">âœï¸ å‡ºæ¬ è¨˜éŒ²</h3>
            <div class="mb-3"><label class="block text-xs text-gray-600 mb-1">æ—¥ä»˜</label>
              <input type="date" id="genAttDate" class="inp w-full px-4 py-2 rounded-lg">
            </div>
            <div class="mb-3"><label class="block text-xs text-gray-600 mb-1">éƒ¨å“¡ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
              <div class="ms-con" id="genAttMembers"><div class="text-gray-500 text-sm p-4">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>
            <div class="mb-3"><label class="block text-xs text-gray-600 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select id="genAttStatus" class="inp w-full px-4 py-2 rounded-lg">
                <option value="">é¸æŠ</option><option>å‡ºå¸­</option><option>æ¬ å¸­</option><option>é…åˆ»</option><option>æ—©é€€</option><option>å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯</option>
              </select>
            </div>
            <button class="btn-gen w-full px-6 py-2 rounded-lg" onclick="recordAtt()">è¨˜éŒ²ã™ã‚‹</button>
          </div>
        </div>
        <!-- çµ±è¨ˆ -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“Š å‡ºæ¬ å‰²åˆçµ±è¨ˆ</h3>
          <div class="space-y-3">
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">å‡ºå¸­</span><span class="text-2xl font-bold text-emerald-600" id="st-å‡ºå¸­">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-emerald-500 h-2 rounded-full" id="br-å‡ºå¸­" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">æ¬ å¸­</span><span class="text-2xl font-bold text-rose-600" id="st-æ¬ å¸­">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-rose-500 h-2 rounded-full" id="br-æ¬ å¸­" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">é…åˆ»</span><span class="text-2xl font-bold text-amber-600" id="st-é…åˆ»">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-amber-500 h-2 rounded-full" id="br-é…åˆ»" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">æ—©é€€</span><span class="text-2xl font-bold text-purple-600" id="st-æ—©é€€">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-purple-500 h-2 rounded-full" id="br-æ—©é€€" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯</span><span class="text-2xl font-bold text-blue-600" id="st-å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" id="br-å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯" style="width:0%"></div></div></div>
          </div>
        </div>
      </div>
      <!-- éƒ¨å“¡åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="data-table text-sm">
            <thead><tr><th>æ‹…å½“è€…</th><th>æ›œæ—¥</th><th>å–¶æ¥­æ—¥</th><th>å‡ºå¸­</th><th>æ¬ å¸­</th><th>é…åˆ»</th><th>æ—©é€€</th><th>å¿Œå¼•</th><th>å‡ºå¸­ç‡</th></tr></thead>
            <tbody id="genMemberBody"><tr><td colspan="9" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== æ¸‰å¤–éƒ¨ ========== -->
<div id="externalScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">æ¸‰å¤–éƒ¨ - èª²å¤–æ´»å‹•å±Šå‡¦ç†</h2>
      <div class="bg-blue-50 rounded-xl p-6 mb-6 border border-blue-200">
        <h3 class="font-medium mb-4">ğŸ“„ PDFã‚’é¸æŠã—ã¦AIåˆ†é¡ãƒ»èª­å–</h3>
        <input type="file" id="extPdfInput" accept=".pdf,image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-orange-100 file:text-orange-700 mb-3">
        <div class="flex gap-3 flex-wrap items-center">
          <button class="btn-ext px-6 py-3 rounded-lg font-medium" onclick="analyzeDoc('external')">ğŸ¤– AIåˆ†é¡ãƒ»èª­å–é–‹å§‹</button>
          <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer"><input type="checkbox" id="extTestMode"> âš™ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</label>
        </div>
      </div>
      <div class="flex gap-3 mb-6">
        <button id="extActBtn" class="doc-btn active" onclick="switchExtType('activity')">ğŸ“‹ èª²å¤–æ´»å‹•å±Š</button>
        <button id="extRepBtn" class="doc-btn inactive" onclick="switchExtType('report')">ğŸ“ æ´»å‹•å ±å‘Šæ›¸</button>
      </div>
      <div id="extAiResults" class="space-y-4 mb-6"></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- èª²å¤–æ´»å‹•å±Šãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="extActForm" class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“‹ èª²å¤–æ´»å‹•å±Šæƒ…å ±</h3>
          <div class="space-y-3 mb-4">
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><select id="extClubAct" class="inp w-full px-4 py-2 rounded-lg"></select></div>
            <div><label class="block text-xs text-gray-600 mb-1">æœŸé–“</label><input type="text" id="extPeriod" class="inp w-full px-4 py-2 rounded-lg" placeholder="5æœˆ1æ—¥ã€œ31æ—¥"></div>
            <div class="flex gap-4 flex-wrap">
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="extIsExtra"><span class="text-sm">èª²å¤–</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="extIsOvernight"><span class="text-sm">å®¿æ³Š</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="extIsOfficial"><span class="text-sm">å…¬å¼æˆ¦</span></label>
            </div>
            <div><label class="block text-xs text-gray-600 mb-1">å¤§ä¼šå</label><input type="text" id="extTournament" class="inp w-full px-4 py-2 rounded-lg"></div>
          </div>
          <button class="btn-ext w-full px-5 py-2 rounded-lg font-medium" onclick="saveExtEntry()">âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²</button>
        </div>
        <!-- æ´»å‹•å ±å‘Šæ›¸ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="extRepForm" class="hidden bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“ æ´»å‹•å ±å‘Šæ›¸æƒ…å ±</h3>
          <div class="space-y-3 mb-4">
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><select id="extClubRep" class="inp w-full px-4 py-2 rounded-lg"></select></div>
            <div><label class="block text-xs text-gray-600 mb-1">å ±å‘Šç¨®åˆ¥</label><input type="text" id="extRepType" class="inp w-full px-4 py-2 rounded-lg" placeholder="è©¦åˆ / ç·´ç¿’ / ãã®ä»–"></div>
            <div><label class="block text-xs text-gray-600 mb-1">ä¸»å‚¬</label><input type="text" id="extOrg" class="inp w-full px-4 py-2 rounded-lg"></div>
            <div><label class="block text-xs text-gray-600 mb-1">å‡ºå ´è€…æ•°</label><input type="number" id="extNum" class="inp w-full px-4 py-2 rounded-lg" placeholder="0"></div>
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“æˆç¸¾</label><input type="text" id="extTeamRes" class="inp w-full px-4 py-2 rounded-lg"></div>
            <div><label class="block text-xs text-gray-600 mb-1">å€‹äººæˆç¸¾</label><textarea id="extIndRes" class="inp w-full px-4 py-2 rounded-lg" rows="2"></textarea></div>
          </div>
          <button class="btn-ext w-full px-5 py-2 rounded-lg font-medium" onclick="saveExtEntry()">âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²</button>
        </div>
        <!-- ä¿å­˜æ¸ˆã¿ä¸€è¦§ -->
        <div class="bg-orange-50 rounded-xl p-6 border border-orange-200 h-fit">
          <h3 class="font-medium mb-3">ğŸ“ æœ¬æ—¥ã®è¨˜éŒ²</h3>
          <div id="extSavedList" class="space-y-2 max-h-60 overflow-y-auto"><p class="text-sm text-gray-500">è¨˜éŒ²ãªã—</p></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== ç·¨é›†éƒ¨ ========== -->
<div id="editorialScreen" class="hidden fade-in">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ç·¨é›†éƒ¨ - å›£ä½“DBç®¡ç†</h2>
      <div class="flex gap-3 mb-6">
        <button id="editBtn" class="btn-edi px-6 py-2 rounded-lg text-sm" onclick="switchRoster('edit')">âš™ï¸ DBç·¨é›†</button>
        <button id="procBtn" class="btn-gray px-6 py-2 rounded-lg text-sm" onclick="switchRoster('proc')">ğŸ“‹ åç°¿æ ¡æ­£</button>
      </div>
      <!-- DBç·¨é›† -->
      <div id="rosterEdit">
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <div class="mb-4"><label class="block text-sm font-medium mb-2">ç·¨é›†å¯¾è±¡å›£ä½“</label>
            <select id="editClub" class="inp w-full px-4 py-2 rounded-lg mb-4"></select>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <h4 class="font-medium mb-3">åŸºæœ¬æƒ…å ±</h4>
              <div class="space-y-3">
                <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><input type="text" id="clubName" class="inp w-full px-4 py-2 rounded-lg"></div>
                <div><label class="block text-xs text-gray-600 mb-1">åŒºåˆ†</label>
                  <select id="clubCat" class="inp w-full px-4 py-2 rounded-lg"><option>éƒ¨</option><option>åŒå¥½ä¼š</option><option>æ„›å¥½ä¼š</option></select>
                </div>
              </div>
            </div>
            <div>
              <h4 class="font-medium mb-3">é¡§å•æƒ…å ±</h4>
              <textarea id="advisorNames" class="inp w-full px-4 py-2 rounded-lg" rows="4" placeholder="é¡§å•åï¼ˆ1è¡Œ1åï¼‰"></textarea>
            </div>
          </div>
          <div class="mb-6">
            <h4 class="font-medium mb-3">å¿…é ˆé …ç›®è¨­å®š</h4>
            <div class="flex flex-wrap gap-4">
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fGender" checked><span class="text-sm">æ€§åˆ¥</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fBirth" checked><span class="text-sm">ç”Ÿå¹´æœˆæ—¥</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fPhone" checked><span class="text-sm">æºå¸¯é›»è©±</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fGuardian"><span class="text-sm">ä¿è¨¼äººæºå¸¯</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fAddress"><span class="text-sm">ä½æ‰€</span></label>
            </div>
          </div>
          <div class="flex gap-3">
            <button class="btn-edi px-6 py-2 rounded-lg" onclick="saveClub()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn-gray px-6 py-2 rounded-lg" onclick="resetClub()">â†º ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
      </div>
      <!-- åç°¿æ ¡æ­£ -->
      <div id="rosterProc" class="hidden">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 mb-4">
          <h3 class="font-medium mb-3">ğŸ“Š Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åç°¿ã‚’èª­ã¿è¾¼ã‚€</h3>
          <div class="flex gap-3 flex-wrap items-center mb-3">
            <input type="file" id="rosterFile" accept=".xlsx,.xls,.csv" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-pink-100 file:text-pink-700">
            <button class="btn-edi px-5 py-2 rounded-lg" onclick="loadRoster()">èª­ã¿è¾¼ã‚€</button>
          </div>
        </div>
        <div id="rosterPreview" class="hidden bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-3">ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div class="overflow-x-auto max-h-80 overflow-y-auto mb-4" id="rosterPreviewDiv"></div>
          <div class="flex gap-3">
            <button class="btn-edi px-6 py-2 rounded-lg" onclick="saveRosterData()">âœ“ ç¢ºå®šãƒ»ä¿å­˜</button>
            <button class="btn-gray px-6 py-2 rounded-lg" onclick="document.getElementById('rosterPreview').classList.add('hidden')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== ã‚¤ãƒ™ãƒ³ãƒˆ ========== -->
<div id="eventScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h2>
      <div class="flex gap-3 mb-6">
        <button id="evEventBtn" class="doc-btn active" onclick="switchEvent('form')">ğŸ‰ ãƒ•ã‚©ãƒ¼ãƒ é›†è¨ˆ</button>
        <button id="evFolderBtn" class="doc-btn inactive" onclick="switchEvent('folder')">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button>
      </div>
      <!-- ãƒ•ã‚©ãƒ¼ãƒ é›†è¨ˆ -->
      <div id="evFormSec">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 mb-4">
          <h3 class="font-medium mb-4">ğŸ”— Googleãƒ•ã‚©ãƒ¼ãƒ é›†è¨ˆ</h3>
          <input type="text" id="evFormUrl" class="inp w-full px-4 py-2 rounded-lg mb-3" placeholder="Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›">
          <button class="btn-pri px-6 py-3 rounded-lg font-medium" onclick="collectForm()">é›†è¨ˆã™ã‚‹</button>
        </div>
        <div id="evFormResults" class="space-y-3 mb-4"></div>
        <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200">
          <div class="overflow-x-auto">
            <table class="data-table text-sm">
              <thead><tr><th>æ°å</th><th>æ‰€å±</th><th>æå‡ºçŠ¶æ…‹</th></tr></thead>
              <tbody id="evFormBody"><tr><td colspan="3" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ -->
      <div id="evFolderSec" class="hidden">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
          <h3 class="font-medium mb-4">ğŸ“ Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¸€æ‹¬ä½œæˆ</h3>
          <label class="block text-sm font-medium mb-2">å›£ä½“ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="ms-con mb-4" id="evClubs"></div>
          <div class="mb-4"><label class="block text-xs text-gray-600 mb-1">ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="evSubfolders" class="inp w-full px-4 py-2 rounded-lg" value="ä¼šè­°è³‡æ–™,å‡ºæ¬ ç®¡ç†,ä¼šè¨ˆå ±å‘Š">
          </div>
          <button class="btn-pri px-6 py-3 rounded-lg font-medium" onclick="createFolders()">â• ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</button>
          <div id="evFolderResult" class="mt-4 hidden bg-emerald-50 rounded-xl p-4 border border-emerald-200">
            <p class="text-emerald-800 text-sm font-medium">âœ… ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== ç®¡ç†&è¨­å®š ========== -->
<div id="adminScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ç®¡ç† &amp; è¨­å®š</h2>
      <!-- èªè¨¼ -->
      <div id="adminAuthSec" class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
        <h3 class="font-medium mb-4">ğŸ” ç®¡ç†è€…èªè¨¼</h3>
        <div class="flex gap-4">
          <input type="password" id="adminPw" class="inp px-4 py-2 rounded-lg flex-1" placeholder="ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" onkeydown="if(event.key==='Enter')authenticate()">
          <button class="btn-pri px-6 py-2 rounded-lg" onclick="authenticate()">ğŸ”“ èªè¨¼</button>
        </div>
        <p id="adminAuthMsg" class="text-red-500 text-sm mt-2 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
      </div>
      <div id="adminContent" class="hidden space-y-6">
        <!-- æœ¬éƒ¨å“¡ç®¡ç† -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ‘¥ æœ¬éƒ¨å“¡ç®¡ç†</h3>
          <div id="adminMemberList" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            <input type="text" id="newMName" class="inp border rounded px-3 py-2 text-sm" placeholder="åå‰">
            <select id="newMDept" class="inp border rounded px-3 py-2 text-sm">
              <option>æ›¸è¨˜éƒ¨</option><option>è²¡å‹™éƒ¨</option><option>ç·å‹™éƒ¨</option><option>æ¸‰å¤–éƒ¨</option><option>ç·¨é›†éƒ¨</option><option>ã‚¤ãƒ™ãƒ³ãƒˆ</option>
            </select>
            <select id="newMDay" class="inp border rounded px-3 py-2 text-sm">
              <option>æœˆ</option><option>ç«</option><option>æ°´</option><option>æœ¨</option><option>é‡‘</option><option>åœŸ</option><option>æ—¥</option>
            </select>
            <button onclick="addMember()" class="btn-pri rounded py-2 font-bold text-sm">è¿½åŠ </button>
          </div>
        </div>
        <!-- å‹‰å¼·é€±é–“ -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“š å‹‰å¼·é€±é–“è¨­å®š</h3>
          <div id="studyWkList" class="space-y-2 mb-3"></div>
          <div class="flex gap-2 flex-wrap">
            <input type="date" id="swStart" class="inp border rounded px-3 py-2 text-sm">
            <span class="self-center text-gray-500">ã€œ</span>
            <input type="date" id="swEnd" class="inp border rounded px-3 py-2 text-sm">
            <button onclick="addStudyWeek()" class="btn-pri px-4 py-2 rounded text-sm">è¿½åŠ </button>
          </div>
        </div>
        <!-- Gemini APIã‚­ãƒ¼ -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ¤– Gemini APIã‚­ãƒ¼è¨­å®š</h3>
          <p class="text-xs text-gray-500 mb-3">AIèª­å–æ©Ÿèƒ½ã«å¿…è¦ã§ã™ã€‚<a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-500 underline">Google AI Studio</a>ã§å–å¾—ã§ãã¾ã™ã€‚</p>
          <div class="flex gap-2">
            <input type="password" id="geminiKey" class="inp flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="AIzaSy...">
            <button onclick="saveGeminiKey()" class="btn-pri px-4 py-2 rounded-lg font-bold">ä¿å­˜</button>
          </div>
        </div>
        <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
          <div class="space-y-2 max-w-sm">
            <input type="password" id="pwOld" class="inp w-full border rounded-lg px-3 py-2 text-sm" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <input type="password" id="pwNew" class="inp w-full border rounded-lg px-3 py-2 text-sm" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button onclick="changePw()" class="bg-red-600 text-white px-5 py-2 rounded-lg w-full font-bold hover:bg-red-700">å¤‰æ›´ã™ã‚‹</button>
          </div>
          <p id="pwMsg" class="text-sm mt-2"></p>
        </div>
        <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± -->
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-2">â„¹ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
          <p class="text-sm text-gray-600">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0 | ç®¡ç†å›£ä½“æ•°: 37å›£ä½“</p>
          <p id="adminLastUpdate" class="text-sm text-gray-600"></p>
        </div>
      </div>
    </div>
  </div>
</div>

</main>

<footer class="bg-gray-100 border-t border-gray-200 px-6 py-3 text-center text-xs text-gray-600 flex-shrink-0">
  åƒè‘‰å·¥æ¥­å¤§å­¦ ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.0 | Â© 2025
</footer>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white rounded-xl px-6 py-4 shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
  <span id="toastMsg">å®Œäº†</span>
</div>

<!-- Loading -->
<div id="loadOvl" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl p-8 flex flex-col items-center gap-4 shadow-2xl">
    <div class="spinner"></div>
    <p id="loadMsg" class="text-gray-700 font-bold">å‡¦ç†ä¸­...</p>
  </div>
</div>

<!-- æ–½è¨­è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modalFac" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 w-96 shadow-xl">
    <h3 class="font-semibold mb-4">æ–°ã—ã„æ–½è¨­ã‚’è¿½åŠ </h3>
    <input type="text" id="newFacName" class="inp w-full px-4 py-2 rounded-lg mb-4" placeholder="æ–½è¨­å">
    <div class="flex gap-3">
      <button class="flex-1 btn-sec px-4 py-2 rounded-lg" onclick="confirmFac()">è¿½åŠ </button>
      <button class="flex-1 btn-gray px-4 py-2 rounded-lg" onclick="document.getElementById('modalFac').classList.add('hidden')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// å®šæ•°
// ============================================================
const GAS_URL = "https://script.google.com/macros/s/AKfycby1IkqujrZVOEzZ4nbMUBD1XS1iPu2t0ahb6dVp_88rDG04W9D5OCc2S17pB6TwzcpemA/exec";

const CLUBS = ["åˆæ°—é“éƒ¨","ã‚¦ã‚£ãƒ³ãƒ‰ã‚µãƒ¼ãƒ•ã‚£ãƒ³éƒ¨","ç©ºæ‰‹é“éƒ¨","å¼“é“éƒ¨","å‰£é“éƒ¨","èˆªç©ºéƒ¨","ç¡¬å¼åº­çƒéƒ¨","ç¡¬å¼é‡çƒéƒ¨","ã‚´ãƒ«ãƒ•éƒ¨","ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°éƒ¨","ã‚µãƒƒã‚«ãƒ¼åŒå¥½ä¼š","ã‚µãƒã‚¤ãƒãƒ«ã‚²ãƒ¼ãƒ åŒå¥½ä¼š","å±±å²³éƒ¨","è‡ªå‹•è»Šéƒ¨","å°‘æ—å¯ºæ‹³æ³•éƒ¨","å°„æ’ƒéƒ¨","æŸ”é“éƒ¨","æ°´æ³³","ã‚¹ã‚­ãƒ¥ãƒ¼ãƒãƒ€ã‚¤ãƒ“ãƒ³ã‚°åŒå¥½ä¼š","èº°é“éƒ¨","ç¬¬äºŒãƒ†ãƒ‹ã‚¹åŒå¥½ä¼š","å“çƒéƒ¨","ãƒ†ã‚³ãƒ³ãƒ‰ãƒ¼æ„›å¥½ä¼š","è»Ÿå¼é‡çƒéƒ¨","äºŒè¼ªåŒå¥½ä¼š","ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«åŒå¥½ä¼š","ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³éƒ¨","ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«åŒå¥½ä¼š","ãƒãƒ³ãƒ‰ãƒœãƒ¼ãƒ«éƒ¨","ãƒ“ãƒ¼ãƒãƒãƒ¬ãƒ¼æ„›å¥½ä¼š","ãƒ•ã‚©ãƒ¼ã‚¯ãƒ€ãƒ³ã‚¹éƒ¨","ãƒ•ãƒƒãƒˆã‚µãƒ«æ„›å¥½ä¼š","ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ãƒ‡ã‚£ã‚¹ã‚¯æ„›å¥½ä¼š","ã‚ˆã•ã“ã„ã‚½ãƒ¼ãƒ©ãƒ³é¢¨ç¥éƒ¨","ãƒ©ã‚°ãƒ“ãƒ¼éƒ¨","é™¸ä¸Šç«¶æŠ€éƒ¨","ãƒ¯ãƒ³ãƒ€ãƒ¼ãƒ•ã‚©ãƒ¼ã‚²ãƒ«åŒå¥½ä¼š"];

const DEF_SUBJ = ["å‰æœˆç¹°è¶Šé‡‘","é é‡‘å£åº§å…¥é‡‘","é é‡‘å£åº§å‡ºé‡‘","å›£ä½“æ´»å‹•è²»","è‡¨æ™‚å¾´åé‡‘","OBæ´åŠ©é‡‘","ä¼ç”»è²»","ç·å‹™è²»","æ¸‰å¤–è²»","äº¤é€šè²»"];

// ============================================================
// çŠ¶æ…‹
// ============================================================
let members = [];
let finEntries = [];
let finSubjs = [...DEF_SUBJ];
let attData = [];
let studyWks = [];
let extDocType = 'activity';
let rosterRows = [];

// ============================================================
// åˆæœŸåŒ–
// ============================================================
window.onload = async () => {
  initSelects();
  setToday();
  await checkGAS();
  await loadMembers();
  await loadFinEntries();
};

function setToday() {
  const t = new Date().toISOString().split('T')[0];
  ['finDate','secDate','genAttDate'].forEach(id => { const el=document.getElementById(id); if(el) el.value=t; });
}

function initSelects() {
  const opts = '<option value="">é¸æŠ</option>' + CLUBS.map(c=>`<option>${c}</option>`).join('');
  ['secClub','extClubAct','extClubRep','editClub'].forEach(id => {
    const el = document.getElementById(id); if(el) el.innerHTML = opts;
  });
  // ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã‚¯ãƒ©ãƒ–ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
  const ev = document.getElementById('evClubs');
  if(ev) ev.innerHTML = CLUBS.map(c=>`<label class="ms-item"><input type="checkbox" class="evCb w-4 h-4 rounded" value="${c}"><span class="text-sm">${c}</span></label>`).join('');
  // è²¡å‹™ç§‘ç›®
  renderFinSubjs();
}

async function checkGAS() {
  const el = document.getElementById('gasStatus');
  try {
    const r = await fetch(GAS_URL);
    const d = await r.json();
    if(d.success) { el.textContent = 'â— GASæ¥ç¶šæ¸ˆã¿'; el.className = 'text-xs text-emerald-600'; }
  } catch(e) { el.textContent = 'â— GASæ¥ç¶šã‚¨ãƒ©ãƒ¼'; el.className = 'text-xs text-red-500'; }
}

// ============================================================
// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
// ============================================================
function navigateTo(s) {
  document.querySelectorAll('[id$="Screen"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(s+'Screen').classList.remove('hidden');
  document.getElementById('backBtn').classList.toggle('hidden', s==='home');
  const titles = { home:'ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ', secretary:'æ›¸è¨˜éƒ¨ - æ–½è¨­äºˆç´„ç®¡ç†', finance:'è²¡å‹™éƒ¨ - å‡ºç´å¸³ç®¡ç†', general:'ç·å‹™éƒ¨ - å‡ºæ¬ ç®¡ç†ãƒ»çµ±è¨ˆ', external:'æ¸‰å¤–éƒ¨ - èª²å¤–æ´»å‹•å±Šå‡¦ç†', editorial:'ç·¨é›†éƒ¨ - å›£ä½“DBç®¡ç†', event:'ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†', admin:'ç®¡ç† & è¨­å®š' };
  document.getElementById('pageTitle').textContent = titles[s] || 'ã‚·ã‚¹ãƒ†ãƒ ';
  if(s==='general') loadGeneral();
  if(s==='admin') loadAdmin();
}

// ============================================================
// Toast / Loading
// ============================================================
function toast(msg, dur=3000) {
  const t=document.getElementById('toast');
  document.getElementById('toastMsg').textContent=msg;
  t.classList.remove('translate-y-20','opacity-0'); t.classList.add('translate-y-0','opacity-100');
  setTimeout(()=>{ t.classList.add('translate-y-20','opacity-0'); t.classList.remove('translate-y-0','opacity-100'); }, dur);
}
function showLoad(msg='å‡¦ç†ä¸­...') { document.getElementById('loadMsg').textContent=msg; document.getElementById('loadOvl').classList.remove('hidden'); }
function hideLoad() { document.getElementById('loadOvl').classList.add('hidden'); }

// ============================================================
// GASå‘¼ã³å‡ºã—
// ============================================================
async function gas(action, data={}) {
  const r = await fetch(GAS_URL, { method:'POST', body:JSON.stringify({action,...data}), headers:{'Content-Type':'text/plain'} });
  return r.json();
}

// ============================================================
// ãƒ•ã‚¡ã‚¤ãƒ«â†’Base64å¤‰æ›
// ============================================================
async function fileToBase64(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
}

// ============================================================
// æ›¸è¨˜éƒ¨
// ============================================================
function handleFacilityChange() {
  const s = document.getElementById('secFacility');
  if(s.value === 'æ–°è¦è¿½åŠ ') { s.value=''; document.getElementById('modalFac').classList.remove('hidden'); }
}
function confirmFac() {
  const n = document.getElementById('newFacName').value.trim(); if(!n) return;
  const s = document.getElementById('secFacility');
  const o = document.createElement('option'); o.value=n; o.textContent=n;
  s.insertBefore(o, s.lastElementChild); s.value=n;
  document.getElementById('modalFac').classList.add('hidden');
  document.getElementById('newFacName').value='';
  toast(`ã€Œ${n}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
}

async function analyzeDoc(dept) {
  const inputId = dept==='secretary' ? 'secPdfInput' : 'extPdfInput';
  const file = document.getElementById(inputId).files[0];
  if(!file) { toast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  showLoad('AIèª­å–ä¸­...');
  try {
    const b64 = await fileToBase64(file);
    const type = dept==='secretary' ? 'å€Ÿç”¨å±Š' : 'æ¸‰å¤–';
    const r = await gas('analyzeDocument', { imageBase64: b64, type });
    const divId = dept==='secretary' ? 'secAiResults' : 'extAiResults';
    const div = document.getElementById(divId); div.innerHTML='';
    if(r.success && r.data && r.data.length) {
      r.data.forEach((item,i) => div.appendChild(mkAiCard(item, i, dept)));
      toast(`âœ… ${r.data.length}ä»¶ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ`);
    } else {
      div.innerHTML='<div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-yellow-800 text-sm">âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>';
    }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

function mkAiCard(item, idx, dept) {
  const cf = item.confidence||0;
  const cls = cf>=.8?'cf-hi':cf>=.6?'cf-md':'cf-lo';
  const em = cf>=.8?'ğŸŸ¢':cf>=.6?'ğŸŸ¡':'ğŸ”´';
  const d = document.createElement('div');
  d.className = 'ai-card'+(cf<.7?' warn':'');
  const fields = dept==='secretary' ? `
    <div class="flex items-center gap-2 text-sm">
      <span class="w-16 text-gray-500 shrink-0">å›£ä½“å</span>
      <select id="ai-club-${idx}" class="inp flex-1 border rounded px-2 py-1 text-sm">${CLUBS.map(c=>`<option ${c===(item['å›£ä½“å']||'')?'selected':''}>${c}</option>`).join('')}</select>
    </div>
    <div class="flex items-center gap-2 text-sm"><span class="w-16 text-gray-500 shrink-0">æ–½è¨­</span><input id="ai-fac-${idx}" value="${item['æ–½è¨­']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
    <div class="flex items-center gap-2 text-sm"><span class="w-16 text-gray-500 shrink-0">æ—¥ä»˜</span><input type="date" id="ai-date-${idx}" value="${item['æ—¥ä»˜']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
    <div class="flex gap-3 text-sm">
      <div class="flex items-center gap-1 flex-1"><span class="text-gray-500 shrink-0">é–‹å§‹</span><input type="time" id="ai-st-${idx}" value="${item['é–‹å§‹æ™‚é–“']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
      <div class="flex items-center gap-1 flex-1"><span class="text-gray-500 shrink-0">çµ‚äº†</span><input type="time" id="ai-en-${idx}" value="${item['çµ‚äº†æ™‚é–“']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
    </div>`
  : `<div class="text-sm space-y-1">
      <p><span class="text-gray-500">ç¨®åˆ¥: </span>${item.document_type||'ä¸æ˜'}</p>
      <p><span class="text-gray-500">å›£ä½“: </span>${item.club_name||''}</p>
      <p><span class="text-gray-500">æœŸé–“: </span>${item.period||''}</p>
    </div>`;
  d.innerHTML=`
    <div class="flex justify-between items-center mb-3">
      <h4 class="font-bold text-sm">ğŸ“‹ èª­å–çµæœ ${idx+1}</h4>
      <span class="${cls} font-bold text-sm">${em} ${Math.round(cf*100)}%</span>
    </div>
    ${cf<.7?'<p class="text-orange-600 text-xs mb-2">âš ï¸ ç¢ºä¿¡åº¦ãŒä½ã„ãŸã‚ç¢ºèªã—ã¦ãã ã•ã„</p>':''}
    <div class="space-y-2">${fields}</div>
    <button onclick="applyAiCard(${idx},'${dept}')" class="btn-pri w-full px-3 py-2 rounded-lg text-sm mt-3">â†“ ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨</button>`;
  return d;
}

function applyAiCard(idx, dept) {
  const v = id => document.getElementById(id)?.value;
  if(dept==='secretary') {
    const club=v(`ai-club-${idx}`), fac=v(`ai-fac-${idx}`), date=v(`ai-date-${idx}`), st=v(`ai-st-${idx}`), en=v(`ai-en-${idx}`);
    if(club) document.getElementById('secClub').value=club;
    if(fac) document.getElementById('secFacility').value=fac;
    if(date) document.getElementById('secDate').value=date;
    if(st) document.getElementById('secStart').value=st;
    if(en) document.getElementById('secEnd').value=en;
  }
  toast('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨ã—ã¾ã—ãŸ');
}

async function saveSecEntry() {
  const fac=document.getElementById('secFacility').value, date=document.getElementById('secDate').value;
  if(!fac||!date) { toast('æ–½è¨­ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const test = document.getElementById('secTestMode').checked;
  if(test) { toast('âœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šå…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ'); return; }
  showLoad('è¨˜éŒ²ä¸­...');
  try {
    const r = await gas('saveSecretaryLog', { data:{ 'å›£ä½“å':document.getElementById('secClub').value, 'æ–½è¨­':fac, 'æ—¥ä»˜':date, 'é–‹å§‹æ™‚é–“':document.getElementById('secStart').value, 'çµ‚äº†æ™‚é–“':document.getElementById('secEnd').value, 'ç¢ºä¿¡åº¦':1 } });
    if(r.success) {
      addSaved('secSavedList', `${fac} | ${date} ${document.getElementById('secStart').value}ã€œ${document.getElementById('secEnd').value}`);
      toast('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸ');
    }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

// ============================================================
// æ¸‰å¤–éƒ¨
// ============================================================
function switchExtType(t) {
  extDocType=t;
  document.getElementById('extActBtn').className=t==='activity'?'doc-btn active':'doc-btn inactive';
  document.getElementById('extRepBtn').className=t==='report'?'doc-btn active':'doc-btn inactive';
  document.getElementById('extActForm').classList.toggle('hidden',t!=='activity');
  document.getElementById('extRepForm').classList.toggle('hidden',t!=='report');
}

async function saveExtEntry() {
  const test = extDocType==='activity' ? document.getElementById('extTestMode').checked : document.getElementById('extTestMode').checked;
  const isAct = extDocType==='activity';
  const data = isAct ? {
    'æ–‡æ›¸ç¨®åˆ¥':'èª²å¤–æ´»å‹•å±Š', 'å›£ä½“å':document.getElementById('extClubAct').value,
    'æœŸé–“':document.getElementById('extPeriod').value, 'èª²å¤–':document.getElementById('extIsExtra').checked,
    'å®¿æ³Š':document.getElementById('extIsOvernight').checked, 'å…¬å¼æˆ¦':document.getElementById('extIsOfficial').checked,
    'å¤§ä¼šå':document.getElementById('extTournament').value, 'å ±å‘Šç¨®åˆ¥':'','ä¸»å‚¬':'','å‡ºå ´è€…æ•°':0,'å›£ä½“æˆç¸¾':'','å€‹äººæˆç¸¾':'','ç¢ºä¿¡åº¦':1
  } : {
    'æ–‡æ›¸ç¨®åˆ¥':'æ´»å‹•å ±å‘Šæ›¸', 'å›£ä½“å':document.getElementById('extClubRep').value,
    'æœŸé–“':'','èª²å¤–':false,'å®¿æ³Š':false,'å…¬å¼æˆ¦':false,'å¤§ä¼šå':'',
    'å ±å‘Šç¨®åˆ¥':document.getElementById('extRepType').value, 'ä¸»å‚¬':document.getElementById('extOrg').value,
    'å‡ºå ´è€…æ•°':parseInt(document.getElementById('extNum').value)||0,
    'å›£ä½“æˆç¸¾':document.getElementById('extTeamRes').value, 'å€‹äººæˆç¸¾':document.getElementById('extIndRes').value, 'ç¢ºä¿¡åº¦':1
  };
  if(test) { toast('âœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šå…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ'); return; }
  showLoad('è¨˜éŒ²ä¸­...');
  try {
    const r = await gas('saveExternalLog', { data });
    if(r.success) { addSaved('extSavedList', `${data['æ–‡æ›¸ç¨®åˆ¥']} | ${data['å›£ä½“å']}`); toast('âœ… è¨˜éŒ²ã—ã¾ã—ãŸ'); }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

function addSaved(id, txt) {
  const el=document.getElementById(id);
  const p=el.querySelector('.text-gray-500'); if(p) p.remove();
  const d=document.createElement('div');
  d.className='bg-white rounded-lg p-3 border border-gray-200 text-sm text-gray-900';
  d.textContent='âœ“ '+txt; el.appendChild(d);
}

// ============================================================
// è²¡å‹™éƒ¨
// ============================================================
function renderFinSubjs() {
  const s=document.getElementById('finSubj'); if(!s) return;
  s.innerHTML=finSubjs.map(x=>`<option>${x}</option>`).join('');
}

function addFinSubj() {
  const n=prompt('æ–°ã—ã„ç§‘ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:'); if(!n||!n.trim()) return;
  finSubjs.push(n.trim()); renderFinSubjs(); document.getElementById('finSubj').value=n.trim();
  toast('âœ… ç§‘ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

async function loadFinEntries() {
  try {
    const r = await gas('getFinanceEntries');
    if(r.success) { finEntries=r.data; renderFinance(); }
  } catch(e) {}
}

async function addFinEntry() {
  const date=document.getElementById('finDate').value, subj=document.getElementById('finSubj').value;
  if(!date||!subj) { toast('æ—¥ä»˜ã¨ç§‘ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const pay=document.querySelector('input[name="finPay"]:checked')?.value;
  const inc=parseInt(document.getElementById('finIncome').value)||0;
  const exp=parseInt(document.getElementById('finExpense').value)||0;
  const rep=document.querySelector('input[name="finRepl"]:checked')?.value||'/';
  const memo=document.getElementById('finMemo').value;
  showLoad('ä¿å­˜ä¸­...');
  try {
    await gas('addFinanceEntry', { data:{'æ—¥ä»˜':date,'è¡Œäº‹ãƒ»ç§‘ç›®':subj,'æ‘˜è¦':memo,'æ”¯æ‰•æ–¹æ³•':pay,'åå…¥':inc,'æ”¯å‡º':exp,'ç«‹æ›¿çŠ¶æ…‹':rep} });
    finEntries.push({'æ—¥ä»˜':date,'è¡Œäº‹ãƒ»ç§‘ç›®':subj,'æ‘˜è¦':memo,'æ”¯æ‰•æ–¹æ³•':pay,'åå…¥':inc,'æ”¯å‡º':exp,'ç«‹æ›¿çŠ¶æ…‹':rep});
    renderFinance();
    document.getElementById('finMemo').value=''; document.getElementById('finIncome').value=''; document.getElementById('finExpense').value='';
    toast('âœ… è¿½åŠ ã—ã¾ã—ãŸ');
  } catch(e) {
    finEntries.push({'æ—¥ä»˜':date,'è¡Œäº‹ãƒ»ç§‘ç›®':subj,'æ‘˜è¦':memo,'æ”¯æ‰•æ–¹æ³•':pay,'åå…¥':inc,'æ”¯å‡º':exp,'ç«‹æ›¿çŠ¶æ…‹':rep});
    renderFinance(); toast('âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¾ã—ãŸï¼ˆGASã‚¨ãƒ©ãƒ¼ï¼‰');
  }
  hideLoad();
}

async function delFinEntry(i) {
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  showLoad('å‰Šé™¤ä¸­...');
  try { await gas('deleteFinanceEntry',{index:i}); } catch(e){}
  finEntries.splice(i,1); renderFinance(); hideLoad(); toast('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
}

function renderFinance() {
  let cash=0, bank=0;
  finEntries.forEach(e=>{ if(e['æ”¯æ‰•æ–¹æ³•']==='ç¾é‡‘') cash+=(e['åå…¥']||0)-(e['æ”¯å‡º']||0); else bank+=(e['åå…¥']||0)-(e['æ”¯å‡º']||0); });
  document.getElementById('finCash').textContent='Â¥'+cash.toLocaleString();
  document.getElementById('finBank').textContent='Â¥'+bank.toLocaleString();
  document.getElementById('finTotal').textContent='Â¥'+(cash+bank).toLocaleString();
  const tb=document.getElementById('finBody');
  if(!finEntries.length) { tb.innerHTML='<tr><td colspan="8" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'; return; }
  tb.innerHTML=finEntries.map((e,i)=>{
    const cls=e['ç«‹æ›¿çŠ¶æ…‹']==='æœªè¿”é‡‘'?'row-unreturned':e['ç«‹æ›¿çŠ¶æ…‹']==='è¿”é‡‘æ¸ˆ'?'row-returned':'';
    return `<tr class="${cls}">
      <td>${e['æ—¥ä»˜']}</td><td>${e['è¡Œäº‹ãƒ»ç§‘ç›®']}</td><td>${e['æ‘˜è¦']||''}</td>
      <td>${e['æ”¯æ‰•æ–¹æ³•']==='ç¾é‡‘'?'ğŸ’µ':'ğŸ¦'} ${e['æ”¯æ‰•æ–¹æ³•']}</td>
      <td class="text-right text-emerald-700">${e['åå…¥']>0?'Â¥'+e['åå…¥'].toLocaleString():''}</td>
      <td class="text-right text-rose-700">${e['æ”¯å‡º']>0?'Â¥'+e['æ”¯å‡º'].toLocaleString():''}</td>
      <td class="text-center text-xs">${e['ç«‹æ›¿çŠ¶æ…‹']}</td>
      <td class="text-center"><button onclick="delFinEntry(${i})" class="text-red-400 hover:text-red-600 text-xs">å‰Šé™¤</button></td>
    </tr>`;
  }).join('');
}

async function exportFinance(type) {
  const query = type==='monthly' ? prompt('å‡ºåŠ›ã™ã‚‹æœˆï¼ˆä¾‹: 2026-01ï¼‰:') : prompt('å¹´åº¦ï¼ˆä¾‹: 2025ï¼‰:');
  if(!query) return;
  showLoad('Excelç”Ÿæˆä¸­...');
  try {
    const r = await gas('exportFinanceExcel', type==='monthly'?{month:query}:{year:query});
    if(r.success) {
      toast(`âœ… Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ã—ã¾ã—ãŸ`);
      if(r.fileUrl) window.open(r.fileUrl,'_blank');
    }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

// ============================================================
// ç·å‹™éƒ¨
// ============================================================
async function loadGeneral() {
  await loadMembers();
  renderMemberCbs('genWeekdayMembers','wCb');
  renderMemberCbs('genAttMembers','aCb');
  await loadAttStats();
}

function renderMemberCbs(cid, cls) {
  const c=document.getElementById(cid); if(!c) return;
  if(!members.length) { c.innerHTML='<div class="text-gray-500 text-sm p-4">æœ¬éƒ¨å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'; return; }
  c.innerHTML=members.map(m=>`<label class="ms-item cursor-pointer"><input type="checkbox" class="${cls} w-4 h-4 rounded" value="${m['åå‰']}"><span class="text-sm">${m['åå‰']}<span class="text-gray-400 ml-1">(${m['éƒ¨ç½²']})</span></span></label>`).join('');
}

async function saveWeekday() {
  const day=document.getElementById('genWeekday').value;
  const sel=[...document.querySelectorAll('.wCb:checked')].map(c=>c.value);
  if(!day||!sel.length) { toast('æ›œæ—¥ã¨éƒ¨å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  showLoad('ä¿å­˜ä¸­...');
  try {
    const cur=(await gas('getWeekdayAssignments')).data||{};
    cur[day]=sel;
    await gas('saveWeekdayAssignments',{data:cur});
    toast(`âœ… ${day}æ›œæ—¥ã®æ‹…å½“ï¼ˆ${sel.length}åï¼‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

async function recordAtt() {
  const date=document.getElementById('genAttDate').value, status=document.getElementById('genAttStatus').value;
  const sel=[...document.querySelectorAll('.aCb:checked')].map(c=>c.value);
  if(!date||!sel.length||!status) { toast('æ—¥ä»˜ãƒ»éƒ¨å“¡ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å…¨ã¦é¸æŠã—ã¦ãã ã•ã„'); return; }
  showLoad('è¨˜éŒ²ä¸­...');
  try {
    for(const name of sel) await gas('recordAttendance',{data:{'æ—¥ä»˜':date,'æœ¬éƒ¨å“¡å':name,'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹':status}});
    toast(`âœ… ${sel.length}åã®å‡ºæ¬ ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
    await loadAttStats();
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

async function loadAttStats() {
  try {
    const r=await gas('getAttendance'); if(!r.success) return;
    attData=r.data;
    const ks=['å‡ºå¸­','æ¬ å¸­','é…åˆ»','æ—©é€€','å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯'], cnts={};
    ks.forEach(k=>cnts[k]=0);
    attData.forEach(x=>{ if(cnts[x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']]!==undefined) cnts[x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']]++; });
    const tot=Object.values(cnts).reduce((a,b)=>a+b,0)||1;
    ks.forEach(k=>{ const p=Math.round(cnts[k]/tot*100); const s=document.getElementById('st-'+k),b=document.getElementById('br-'+k); if(s)s.textContent=p+'%'; if(b)b.style.width=p+'%'; });
    const tb=document.getElementById('genMemberBody');
    if(tb&&members.length) tb.innerHTML=members.map(m=>{
      const my=attData.filter(x=>x['æœ¬éƒ¨å“¡å']===m['åå‰']), att=my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='å‡ºå¸­').length, tot2=my.length||1;
      return `<tr><td>${m['åå‰']}</td><td class="text-center">${m['æ‹…å½“æ›œæ—¥']||'-'}</td><td class="text-center">${tot2}</td><td class="text-center text-emerald-700 font-bold">${att}</td><td class="text-center text-rose-700">${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='æ¬ å¸­').length}</td><td class="text-center text-amber-700">${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='é…åˆ»').length}</td><td class="text-center text-purple-700">${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='æ—©é€€').length}</td><td class="text-center text-blue-700">${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯').length}</td><td class="text-right font-bold">${Math.round(att/tot2*100)}%</td></tr>`;
    }).join('');
  } catch(e) {}
}

// ============================================================
// ç·¨é›†éƒ¨
// ============================================================
function switchRoster(m) {
  document.getElementById('rosterEdit').classList.toggle('hidden',m!=='edit');
  document.getElementById('rosterProc').classList.toggle('hidden',m!=='proc');
  document.getElementById('editBtn').className=m==='edit'?'btn-edi px-6 py-2 rounded-lg text-sm':'btn-gray px-6 py-2 rounded-lg text-sm';
  document.getElementById('procBtn').className=m==='proc'?'btn-edi px-6 py-2 rounded-lg text-sm':'btn-gray px-6 py-2 rounded-lg text-sm';
}

function saveClub() { toast('âœ… å›£ä½“æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); }
function resetClub() { ['clubName','advisorNames'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';}); document.getElementById('editClub').value=''; }

async function loadRoster() {
  const file=document.getElementById('rosterFile').files[0];
  if(!file) { toast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const reader=new FileReader();
  reader.onload=e=>{
    let rows=[];
    if(file.name.endsWith('.csv')) {
      rows=e.target.result.split('\n').map(r=>r.split(',').map(c=>c.trim().replace(/^"|"$/g,'')));
    } else {
      // xlsxèª­ã¿è¾¼ã¿ï¼ˆç°¡æ˜“ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼‰
      toast('âš ï¸ xlsxèª­ã¿è¾¼ã¿ã«ã¯SheetJSãŒå¿…è¦ã§ã™ã€‚CSVã§ãŠè©¦ã—ãã ã•ã„');
      return;
    }
    rosterRows=rows;
    const prev=document.getElementById('rosterPreviewDiv');
    prev.innerHTML=`<table class="data-table text-xs">${rows.map((row,i)=>`<tr class="${i===0?'font-bold bg-gray-100':''}">${row.map(c=>`<td class="px-2 py-1">${c||''}</td>`).join('')}</tr>`).join('')}</table>`;
    document.getElementById('rosterPreview').classList.remove('hidden');
    toast(`âœ… ${rows.length-1}è¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  };
  reader.readAsText(file,'UTF-8');
}

async function saveRosterData() {
  const club=document.getElementById('editClub').value;
  if(!club) { toast('å›£ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  showLoad('ä¿å­˜ä¸­...');
  try {
    await gas('saveRoster',{club,data:rosterRows.slice(1)});
    toast('âœ… åç°¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    document.getElementById('rosterPreview').classList.add('hidden');
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

// ============================================================
// ã‚¤ãƒ™ãƒ³ãƒˆ
// ============================================================
function switchEvent(m) {
  document.getElementById('evEventBtn').className=m==='form'?'doc-btn active':'doc-btn inactive';
  document.getElementById('evFolderBtn').className=m==='folder'?'doc-btn active':'doc-btn inactive';
  document.getElementById('evFormSec').classList.toggle('hidden',m!=='form');
  document.getElementById('evFolderSec').classList.toggle('hidden',m!=='folder');
}

async function collectForm() {
  const url=document.getElementById('evFormUrl').value.trim();
  if(!url) { toast('ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showLoad('å›ç­”å–å¾—ä¸­...');
  try {
    const r=await gas('getFormResponses',{formUrl:url});
    const div=document.getElementById('evFormResults');
    if(r.success) {
      const sub=new Set(r.data.map(x=>Object.values(x)[1]).filter(Boolean));
      const unsub=members.filter(m=>!sub.has(m['åå‰']));
      div.innerHTML=`<div class="grid grid-cols-2 gap-4 mb-3">
        <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200"><p class="text-sm text-emerald-700">æå‡ºæ¸ˆã¿</p><p class="text-2xl font-bold text-emerald-900">${sub.size}å</p></div>
        <div class="bg-rose-50 rounded-xl p-4 border border-rose-200"><p class="text-sm text-rose-700">æœªæå‡º</p><p class="text-2xl font-bold text-rose-900">${unsub.length}å</p></div>
      </div>${unsub.length?`<div class="bg-rose-50 rounded-xl p-3 border border-rose-200 text-sm"><strong>æœªæå‡ºè€…:</strong> ${unsub.map(m=>m['åå‰']).join('ã€')}</div>`:''}`;
      document.getElementById('evFormBody').innerHTML=members.map(m=>{
        const ok=sub.has(m['åå‰']);
        return `<tr><td>${m['åå‰']}</td><td>${m['éƒ¨ç½²']||''}</td><td class="text-center"><span class="px-2 py-1 rounded-full text-xs font-semibold ${ok?'bg-emerald-100 text-emerald-800':'bg-rose-100 text-rose-800'}">${ok?'âœ“ æå‡º':'æœªæå‡º'}</span></td></tr>`;
      }).join('');
      toast('âœ… é›†è¨ˆã—ã¾ã—ãŸ');
    } else { toast('âŒ '+r.error); }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

async function createFolders() {
  const clubs=[...document.querySelectorAll('.evCb:checked')].map(c=>c.value);
  const subs=document.getElementById('evSubfolders').value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!clubs.length) { toast('å›£ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  showLoad('ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆä¸­...');
  try {
    const r=await gas('createDriveFolders',{clubs,subfolders:subs});
    if(r.success) {
      document.getElementById('evFolderResult').classList.remove('hidden');
      toast(`âœ… ${clubs.length}å›£ä½“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
    }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

// ============================================================
// æœ¬éƒ¨å“¡
// ============================================================
async function loadMembers() {
  try {
    const r=await gas('getMembers');
    if(r.success) members=r.data;
  } catch(e) { members=[]; }
}

// ============================================================
// ç®¡ç†
// ============================================================
async function loadAdmin() {
  await loadMembers();
  renderAdminMembers();
  loadStudyWkUI();
  document.getElementById('adminLastUpdate').textContent='æœ€çµ‚æ›´æ–°: '+new Date().toLocaleString('ja-JP');
}

function renderAdminMembers() {
  const d=document.getElementById('adminMemberList'); if(!d) return;
  d.innerHTML=members.length ? members.map((m,i)=>`<div class="flex items-center justify-between text-sm p-2 bg-white rounded border border-gray-200">
    <span>${m['åå‰']} <span class="text-gray-400">(${m['éƒ¨ç½²']} / ${m['æ‹…å½“æ›œæ—¥']}æ›œ)</span></span>
    <button onclick="delMember(${i})" class="text-red-400 hover:text-red-600 text-xs">é€€ä¼š</button>
  </div>`).join('') : '<p class="text-gray-400 text-sm">æœ¬éƒ¨å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
}

async function addMember() {
  const n=document.getElementById('newMName').value.trim(), dept=document.getElementById('newMDept').value, day=document.getElementById('newMDay').value;
  if(!n) { toast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showLoad('è¿½åŠ ä¸­...');
  try {
    await gas('addMember',{data:{'åå‰':n,'éƒ¨ç½²':dept,'æ‹…å½“æ›œæ—¥':day,'çŠ¶æ…‹':'åœ¨ç±'}});
    await loadMembers(); renderAdminMembers();
    document.getElementById('newMName').value='';
    toast(`âœ… ${n}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

async function delMember(i) {
  if(!confirm('é€€ä¼šå‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ')) return;
  showLoad('å‡¦ç†ä¸­...');
  try { await gas('deleteMember',{index:i}); await loadMembers(); renderAdminMembers(); toast('âœ… é€€ä¼šå‡¦ç†ã—ã¾ã—ãŸ'); }
  catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

async function authenticate() {
  const pw=document.getElementById('adminPw').value;
  if(!pw) { toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showLoad('èªè¨¼ä¸­...');
  try {
    const r=await gas('verifyPassword',{password:pw});
    if(r.success&&r.valid) {
      document.getElementById('adminContent').classList.remove('hidden');
      document.getElementById('adminAuthSec').classList.add('hidden');
      toast('âœ… èªè¨¼æˆåŠŸ');
    } else {
      document.getElementById('adminAuthMsg').classList.remove('hidden');
    }
  } catch(e) {
    // GASã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆåˆå›è¨­å®šå‰ï¼‰ã¯ãã®ã¾ã¾é–‹ã
    document.getElementById('adminContent').classList.remove('hidden');
    document.getElementById('adminAuthSec').classList.add('hidden');
    toast('âœ… èªè¨¼æˆåŠŸï¼ˆåˆå›ï¼‰');
  }
  hideLoad();
}

async function saveGeminiKey() {
  const k=document.getElementById('geminiKey').value.trim();
  if(!k) { toast('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showLoad('ä¿å­˜ä¸­...');
  try { await gas('saveSettings',{data:{'GeminiAPIã‚­ãƒ¼':k}}); document.getElementById('geminiKey').value=''; toast('âœ… Gemini APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); }
  catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

async function changePw() {
  const op=document.getElementById('pwOld').value, np=document.getElementById('pwNew').value;
  if(!op||!np) { toast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  showLoad('å¤‰æ›´ä¸­...');
  try {
    const r=await gas('changePassword',{oldPassword:op,newPassword:np});
    const msg=document.getElementById('pwMsg');
    if(r.success) { msg.textContent='âœ… å¤‰æ›´ã—ã¾ã—ãŸ'; msg.className='text-green-600 text-sm mt-2'; document.getElementById('pwOld').value=''; document.getElementById('pwNew').value=''; }
    else { msg.textContent='âŒ '+(r.error||'å¤±æ•—ã—ã¾ã—ãŸ'); msg.className='text-red-500 text-sm mt-2'; }
  } catch(e) { toast('âŒ '+e.message); }
  hideLoad();
}

function loadStudyWkUI() {
  const d=document.getElementById('studyWkList'); if(!d) return;
  d.innerHTML=studyWks.length ? studyWks.map((w,i)=>`<div class="flex items-center justify-between text-sm p-2 bg-blue-50 rounded border border-blue-200">
    <span>ğŸ“š ${w.start} ã€œ ${w.end}</span>
    <button onclick="delStudyWk(${i})" class="text-red-400 hover:text-red-600 text-xs">å‰Šé™¤</button>
  </div>`).join('') : '<p class="text-gray-400 text-sm">è¨­å®šãªã—</p>';
}

async function addStudyWeek() {
  const s=document.getElementById('swStart').value, e=document.getElementById('swEnd').value;
  if(!s||!e) { toast('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  studyWks.push({start:s,end:e});
  try { await gas('saveSettings',{data:{'å‹‰å¼·é€±é–“':JSON.stringify(studyWks)}}); } catch(er){}
  loadStudyWkUI(); toast('âœ… å‹‰å¼·é€±é–“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

async function delStudyWk(i) {
  studyWks.splice(i,1);
  try { await gas('saveSettings',{data:{'å‹‰å¼·é€±é–“':JSON.stringify(studyWks)}}); } catch(e){}
  loadStudyWkUI(); toast('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
}
</script>
</body>
</html>
