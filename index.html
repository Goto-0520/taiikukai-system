<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åƒè‘‰å·¥æ¥­å¤§å­¦ ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <style>
    * { font-family: 'Noto Sans JP', sans-serif; }
    html, body { height: 100%; background: #fff; }
    .dept-card { background:#fff; transition:all 0.3s; cursor:pointer; }
    .dept-card:hover { transform:translateY(-4px); box-shadow:0 20px 40px rgba(0,0,0,.1); }
    .dept-card-secretary { border:3px solid #1e3a5f; }
    .dept-card-finance    { border:3px solid #f59e0b; }
    .dept-card-general    { border:3px solid #1f2937; }
    .dept-card-external   { border:3px solid #f97316; }
    .dept-card-editorial  { border:3px solid #ec4899; }
    .dept-card-event      { border:3px solid #06b6d4; }
    .dept-card-admin      { border:3px solid #6b7280; }
    .btn-sec  { background:linear-gradient(135deg,#1e3a5f,#0f1f3c); color:#fff; transition:all .2s; }
    .btn-fin  { background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; transition:all .2s; }
    .btn-gen  { background:linear-gradient(135deg,#1f2937,#111827); color:#fff; transition:all .2s; }
    .btn-ext  { background:linear-gradient(135deg,#f97316,#ea580c); color:#fff; transition:all .2s; }
    .btn-edi  { background:linear-gradient(135deg,#ec4899,#db2777); color:#fff; transition:all .2s; }
    .btn-pri  { background:linear-gradient(135deg,#3b82f6,#2563eb); color:#fff; transition:all .2s; }
    .btn-sec:hover,.btn-fin:hover,.btn-gen:hover,.btn-ext:hover,.btn-edi:hover,.btn-pri:hover { transform:scale(1.02); filter:brightness(.9); }
    .btn-gray { background:#e5e7eb; color:#374151; transition:all .2s; }
    .btn-gray:hover { background:#d1d5db; }
    .fade-in { animation:fadeIn .4s ease-out; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .data-table { border-collapse:collapse; width:100%; }
    .data-table th { background:#f3f4f6; border:1px solid #d1d5db; padding:12px 16px; font-weight:600; color:#1f2937; }
    .data-table td { border:1px solid #d1d5db; padding:10px 14px; color:#374151; }
    .data-table tr:hover td { background:#f9fafb; }
    .inp { background:#fff; border:1px solid #d1d5db; color:#1f2937; transition:border-color .2s; }
    .inp:focus { border-color:#3b82f6; outline:none; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .modal-bg { background:rgba(0,0,0,.5); backdrop-filter:blur(4px); }
    .doc-btn { padding:10px 16px; border-radius:8px; font-weight:500; transition:all .2s; cursor:pointer; border:1px solid #d1d5db; }
    .doc-btn.active { background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .doc-btn.inactive { background:#f3f4f6; color:#6b7280; }
    .ms-con { border:1px solid #d1d5db; border-radius:8px; background:#fff; max-height:200px; overflow-y:auto; }
    .ms-item { padding:10px 12px; border-bottom:1px solid #e5e7eb; cursor:pointer; display:flex; align-items:center; gap:10px; }
    .ms-item:hover { background:#f9fafb; }
    .spinner { border:3px solid #f3f3f3; border-top:3px solid #3b82f6; border-radius:50%; width:24px; height:24px; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
    .ai-card { border:2px solid #e5e7eb; border-radius:12px; padding:16px; background:#fff; }
    .ai-card.warn { border-color:#f97316; background:#fff7ed; }
    .cf-hi { color:#16a34a; } .cf-md { color:#d97706; } .cf-lo { color:#dc2626; }
    .row-unreturned { background:#fef9c3 !important; }
    .row-returned   { background:#dcfce7 !important; }
  </style>
</head>
<body class="h-full bg-white text-gray-900 flex flex-col overflow-hidden">
<div id="app" class="h-full flex flex-col">

<!-- Header -->
<header class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-shrink-0">
  <div class="flex items-center gap-4">
    <button id="backBtn" class="hidden btn-gray px-4 py-2 rounded-lg text-sm" onclick="navigateTo('home')">â† ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    <h1 id="pageTitle" class="text-xl font-semibold text-gray-900">ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
  </div>
  <div class="flex items-center gap-3">
    <span id="odStatusHdr" class="text-xs text-gray-500">OneDrive: æœªæ¥ç¶š</span>
    <div id="odDot" class="w-2 h-2 rounded-full bg-gray-300"></div>
  </div>
</header>

<main class="flex-1 overflow-auto px-6 py-6">

<!-- HOME -->
<div id="homeScreen" class="fade-in">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold mb-3 text-gray-900">åƒè‘‰å·¥æ¥­å¤§å­¦ ä½“è‚²ä¼šæœ¬éƒ¨</h2>
      <p class="text-gray-600">37ã‚¯ãƒ©ãƒ–ã‚’çµ±æ‹¬ã™ã‚‹æ¥­å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
      <button class="dept-card dept-card-secretary rounded-2xl p-6 text-left" onclick="navigateTo('secretary')"><h3 class="text-lg font-semibold mb-2">ğŸ“ æ›¸è¨˜éƒ¨</h3><p class="text-sm text-gray-600">æ–½è¨­äºˆç´„ç®¡ç†ãƒ»å€Ÿç”¨å±Šå‡¦ç†</p></button>
      <button class="dept-card dept-card-finance    rounded-2xl p-6 text-left" onclick="navigateTo('finance')"><h3 class="text-lg font-semibold mb-2">ğŸ’° è²¡å‹™éƒ¨</h3><p class="text-sm text-gray-600">å‡ºç´å¸³ç®¡ç†ãƒ»äºˆç®—ç®¡ç†</p></button>
      <button class="dept-card dept-card-general    rounded-2xl p-6 text-left" onclick="navigateTo('general')"><h3 class="text-lg font-semibold mb-2">ğŸ“Š ç·å‹™éƒ¨</h3><p class="text-sm text-gray-600">å‡ºæ¬ ç®¡ç†ãƒ»çµ±è¨ˆåˆ†æ</p></button>
      <button class="dept-card dept-card-external   rounded-2xl p-6 text-left" onclick="navigateTo('external')"><h3 class="text-lg font-semibold mb-2">ğŸ”— æ¸‰å¤–éƒ¨</h3><p class="text-sm text-gray-600">èª²å¤–æ´»å‹•å±Šãƒ»æ´»å‹•å ±å‘Šæ›¸</p></button>
      <button class="dept-card dept-card-editorial  rounded-2xl p-6 text-left" onclick="navigateTo('editorial')"><h3 class="text-lg font-semibold mb-2">âœï¸ ç·¨é›†éƒ¨</h3><p class="text-sm text-gray-600">å›£ä½“DBç®¡ç†ãƒ»åç°¿æ ¡æ­£</p></button>
      <button class="dept-card dept-card-event      rounded-2xl p-6 text-left" onclick="navigateTo('event')"><h3 class="text-lg font-semibold mb-2">ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h3><p class="text-sm text-gray-600">å‚åŠ ç®¡ç†ãƒ»ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</p></button>
    </div>
    <div class="flex justify-center">
      <button class="dept-card dept-card-admin rounded-xl px-8 py-4" onclick="navigateTo('admin')">
        <h3 class="font-semibold">ğŸ”’ ç®¡ç† &amp; è¨­å®š</h3>
        <p class="text-xs text-gray-500">ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ»æ¨©é™ç®¡ç†</p>
      </button>
    </div>
  </div>
</div>

<!-- SECRETARY -->
<div id="secretaryScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">æ›¸è¨˜éƒ¨ - æ–½è¨­äºˆç´„ç®¡ç†</h2>
      <div class="bg-blue-50 rounded-xl p-6 mb-6 border border-blue-200">
        <h3 class="font-medium mb-4">ğŸ“„ å€Ÿç”¨å±ŠPDFã‚’é¸æŠ</h3>
        <input type="file" id="secPdfInput" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-100 file:text-blue-700 mb-3">
        <div class="flex gap-3 flex-wrap">
          <button class="btn-sec px-6 py-3 rounded-lg font-medium" onclick="analyzeSecretaryPDF()">ğŸ¤– AIèª­å–é–‹å§‹</button>
          <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer"><input type="checkbox" id="secTestMode"> âš™ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</label>
        </div>
      </div>
      <div id="secAiResults" class="space-y-4 mb-6"></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“‹ æ–½è¨­ä½¿ç”¨é¡˜ã‚’è¨˜éŒ²</h3>
          <div class="space-y-3 mb-4">
            <div><label class="block text-xs text-gray-600 mb-1">æ–½è¨­</label>
              <select id="secFacility" class="inp w-full px-4 py-2 rounded-lg" onchange="handleFacilityChange()">
                <option value="">é¸æŠ</option>
                <option>ä½“è‚²é¤¨</option><option>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ«ãƒ¼ãƒ </option><option>é™¸ä¸Šç«¶æŠ€å ´</option><option>é‡çƒå ´</option>
                <option>ãƒ“ãƒ¼ãƒãƒãƒ¬ãƒ¼</option><option>ãƒãƒ³ãƒ‰ãƒœãƒ¼ãƒ«ã‚³ãƒ¼ãƒˆ</option><option>ãƒ†ãƒ‹ã‚¹ã‚³ãƒ¼ãƒˆ</option>
                <option>ãƒ©ã‚°ãƒ“ãƒ¼å ´</option><option>ã‚µãƒƒã‚«ãƒ¼å ´</option><option>æ­¦é“é¤¨ï¼ˆå‰£é“å ´ãƒ»æŸ”é“å ´ï¼‰</option>
                <option>å¤šç›®çš„ãƒ«ãƒ¼ãƒ </option><option>æ­¦é“å ´ï¼ˆç©ºæ‰‹é“å ´ï¼‰</option><option>éƒ¨å®¤æ£Ÿä¼šè­°å®¤</option>
                <option>å°„æ’ƒå ´</option><option>å¼“é“å ´</option><option>å±‹å†…ç·´ç¿’å ´</option><option>æ–°ç¿’å¿—é‡é‡çƒå ´</option>
                <option value="æ–°è¦è¿½åŠ ">â• æ–°è¦è¿½åŠ </option>
              </select>
            </div>
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><select id="secClub" class="inp w-full px-4 py-2 rounded-lg"></select></div>
            <div><label class="block text-xs text-gray-600 mb-1">æ—¥ä»˜</label><input type="date" id="secDate" class="inp w-full px-4 py-2 rounded-lg"></div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-xs text-gray-600 mb-1">é–‹å§‹</label><input type="time" id="secStartTime" class="inp w-full px-4 py-2 rounded-lg"></div>
              <div><label class="block text-xs text-gray-600 mb-1">çµ‚äº†</label><input type="time" id="secEndTime" class="inp w-full px-4 py-2 rounded-lg"></div>
            </div>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button class="btn-sec px-5 py-2 rounded-lg font-medium" onclick="saveSecretaryEntry()">âœ… Excelç”Ÿæˆï¼†OneDriveä¿å­˜</button>
            <button class="btn-gray px-4 py-2 rounded-lg text-sm" onclick="savePDFToOneDrive('secretary')">ğŸ“ PDFåŸæœ¬ã‚’ä¿å­˜</button>
          </div>
        </div>
        <div class="bg-orange-50 rounded-xl p-6 border border-orange-200">
          <h3 class="font-medium mb-3">ğŸ“ ä¿å­˜æ¸ˆã¿ä¸€è¦§</h3>
          <div id="secSavedList" class="space-y-2 max-h-64 overflow-y-auto"><p class="text-sm text-gray-500">ä¿å­˜æ¸ˆã¿ãªã—</p></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FINANCE -->
<div id="financeScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">è²¡å‹™éƒ¨ - å‡ºç´å¸³ç®¡ç†</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200"><p class="text-sm text-emerald-700 mb-1">æ‰‹è¨±ç¾é‡‘</p><p id="finCash" class="text-2xl font-bold text-emerald-900">Â¥0</p></div>
        <div class="bg-blue-50 rounded-xl p-4 border border-blue-200"><p class="text-sm text-blue-700 mb-1">é€šå¸³æ®‹é«˜</p><p id="finBank" class="text-2xl font-bold text-blue-900">Â¥0</p></div>
        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200"><p class="text-sm text-gray-700 mb-1">åˆè¨ˆæ®‹é«˜</p><p id="finTotal" class="text-2xl font-bold text-gray-900">Â¥0</p></div>
      </div>
      <div class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
        <h3 class="font-medium mb-4">æ–°è¦å–å¼•å…¥åŠ›</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
          <div><label class="block text-xs text-gray-600 mb-1">æ—¥ä»˜</label><input type="date" id="finDate" class="inp w-full px-4 py-2 rounded-lg"></div>
          <div><label class="block text-xs text-gray-600 mb-1">è¡Œäº‹ãƒ»ç§‘ç›®</label>
            <div class="flex gap-2"><select id="finSubject" class="inp flex-1 px-4 py-2 rounded-lg"></select><button onclick="addFinanceSubject()" class="btn-gray px-3 py-2 rounded-lg text-sm">+</button></div>
          </div>
          <div><label class="block text-xs text-gray-600 mb-1">æ‘˜è¦</label><input type="text" id="finMemo" class="inp w-full px-4 py-2 rounded-lg" placeholder="å†…å®¹ã‚’å…¥åŠ›"></div>
          <div><label class="block text-xs text-gray-600 mb-1">æ”¯æ‰•æ–¹æ³•</label>
            <div class="flex gap-4 mt-2">
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finPayment" value="ç¾é‡‘" checked><span class="text-sm">ç¾é‡‘</span></label>
              <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finPayment" value="é€šå¸³"><span class="text-sm">é€šå¸³</span></label>
            </div>
          </div>
          <div><label class="block text-xs text-gray-600 mb-1">åå…¥ï¼ˆå††ï¼‰</label><input type="number" id="finIncome" class="inp w-full px-4 py-2 rounded-lg" placeholder="0"></div>
          <div><label class="block text-xs text-gray-600 mb-1">æ”¯å‡ºï¼ˆå††ï¼‰</label><input type="number" id="finExpense" class="inp w-full px-4 py-2 rounded-lg" placeholder="0"></div>
        </div>
        <div class="flex items-center gap-6 mb-4">
          <span class="text-xs text-gray-600">ç«‹æ›¿çŠ¶æ…‹</span>
          <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finReplace" value="/" checked><span class="text-sm">/</span></label>
          <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finReplace" value="æœªè¿”é‡‘"><span class="text-sm">æœªè¿”é‡‘</span></label>
          <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="finReplace" value="è¿”é‡‘æ¸ˆ"><span class="text-sm">è¿”é‡‘æ¸ˆ</span></label>
        </div>
        <button class="btn-fin px-6 py-3 rounded-lg font-medium" onclick="addFinanceEntry()">â• è¿½åŠ </button>
      </div>
      <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200 mb-4">
        <div class="overflow-x-auto max-h-80">
          <table class="data-table text-sm">
            <thead><tr><th>æ—¥ä»˜</th><th>ç§‘ç›®</th><th>æ‘˜è¦</th><th>æ”¯æ‰•</th><th>åå…¥</th><th>æ”¯å‡º</th><th>ç«‹æ›¿</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="finLedger"><tr><td colspan="8" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="flex gap-3 flex-wrap">
        <button class="btn-pri px-5 py-3 rounded-xl font-bold" onclick="exportFinanceMonthly()">ğŸ“„ æœˆåˆ¥Excelâ†’OneDrive</button>
        <button class="px-5 py-3 rounded-xl font-bold text-white" style="background:linear-gradient(135deg,#7c3aed,#5b21b6)" onclick="exportFinanceYearly()">ğŸ“„ å¹´åº¦æœ«å‡ºåŠ›â†’OneDrive</button>
      </div>
    </div>
  </div>
</div>

<!-- GENERAL -->
<div id="generalScreen" class="hidden fade-in">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ç·å‹™éƒ¨ - å‡ºæ¬ ç®¡ç†ãƒ»çµ±è¨ˆ</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="space-y-6">
          <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
            <h3 class="font-medium mb-4">ğŸ“… å­¦æœŸé¸æŠ</h3>
            <select id="genTerm" class="inp w-full px-4 py-2 rounded-lg" onchange="loadBusinessDays()">
              <option>å‰æœŸ (4æœˆã€œ7æœˆ)</option><option>å¤å­£ä¼‘æ¥­ ç¬¬1é€±</option><option>å¤å­£ä¼‘æ¥­ ç¬¬2é€±</option><option>å¤å­£ä¼‘æ¥­ ç¬¬3é€±</option>
              <option>å¾ŒæœŸ (9æœˆã€œ12æœˆ)</option><option>å†¬å­£ä¼‘æ¥­ ç¬¬1é€±</option><option>å†¬å­£ä¼‘æ¥­ ç¬¬2é€±</option><option>å†¬å­£ä¼‘æ¥­ ç¬¬3é€±</option>
            </select>
          </div>
          <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
            <h3 class="font-medium mb-4">ğŸ‘¥ æ›œæ—¥æ‹…å½“è¨­å®š</h3>
            <select id="genWeekday" class="inp w-full px-4 py-2 rounded-lg mb-3" onchange="showMembersForWeekday()">
              <option value="">é¸æŠ</option><option>æœˆ</option><option>ç«</option><option>æ°´</option><option>æœ¨</option><option>é‡‘</option><option>åœŸ</option><option>æ—¥</option>
            </select>
            <div class="ms-con mb-3" id="genWeekdayMembers"><div class="text-gray-500 text-sm p-4">æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</div></div>
            <button class="btn-gen w-full px-4 py-2 rounded-lg" onclick="saveWeekdayAssignment()">è¨­å®šã‚’ä¿å­˜</button>
          </div>
          <div class="bg-emerald-50 rounded-xl p-6 border border-emerald-200">
            <h3 class="font-medium mb-4">âœï¸ å‡ºæ¬ è¨˜éŒ²</h3>
            <input type="date" id="genAttDate" class="inp w-full px-4 py-2 rounded-lg mb-3" onchange="showMembersForDate()">
            <div class="ms-con mb-3" id="genAttMembers"><div class="text-gray-500 text-sm p-4">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div></div>
            <select id="genAttStatus" class="inp w-full px-4 py-2 rounded-lg mb-3">
              <option value="">é¸æŠ</option><option>å‡ºå¸­</option><option>æ¬ å¸­</option><option>é…åˆ»</option><option>æ—©é€€</option><option>å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯</option>
            </select>
            <button class="btn-gen w-full px-6 py-2 rounded-lg" onclick="recordAttendance()">è¨˜éŒ²ã™ã‚‹</button>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“Š å‡ºæ¬ å‰²åˆçµ±è¨ˆ</h3>
          <div class="space-y-3" id="genStats">
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">å‡ºå¸­</span><span class="text-2xl font-bold text-emerald-600" id="st-å‡ºå¸­">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-emerald-500 h-2 rounded-full" id="br-å‡ºå¸­" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">æ¬ å¸­</span><span class="text-2xl font-bold text-rose-600" id="st-æ¬ å¸­">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-rose-500 h-2 rounded-full" id="br-æ¬ å¸­" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">é…åˆ»</span><span class="text-2xl font-bold text-amber-600" id="st-é…åˆ»">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-amber-500 h-2 rounded-full" id="br-é…åˆ»" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">æ—©é€€</span><span class="text-2xl font-bold text-purple-600" id="st-æ—©é€€">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-purple-500 h-2 rounded-full" id="br-æ—©é€€" style="width:0%"></div></div></div>
            <div class="bg-white rounded-lg p-4 border border-gray-200"><div class="flex justify-between mb-2"><span class="text-sm font-medium">å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯</span><span class="text-2xl font-bold text-blue-600" id="st-å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯">0%</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" id="br-å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯" style="width:0%"></div></div></div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200">
        <div class="overflow-x-auto">
          <table class="data-table text-sm">
            <thead><tr><th>æ‹…å½“è€…</th><th>æ›œæ—¥</th><th>å–¶æ¥­æ—¥</th><th>å‡ºå¸­</th><th>æ¬ å¸­</th><th>é…åˆ»</th><th>æ—©é€€</th><th>å¿Œå¼•</th><th>å‡ºå¸­ç‡</th></tr></thead>
            <tbody id="genMemberBody"><tr><td colspan="9" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EXTERNAL -->
<div id="externalScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">æ¸‰å¤–éƒ¨ - èª²å¤–æ´»å‹•å±Šå‡¦ç†</h2>
      <div class="bg-blue-50 rounded-xl p-6 mb-6 border border-blue-200">
        <h3 class="font-medium mb-4">ğŸ“„ PDFã‚’é¸æŠ</h3>
        <input type="file" id="extPdfInput" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-orange-100 file:text-orange-700 mb-3">
        <div class="flex gap-3 flex-wrap">
          <button class="btn-ext px-6 py-3 rounded-lg font-medium" onclick="analyzeExternalPDF()">ğŸ¤– AIåˆ†é¡ãƒ»èª­å–é–‹å§‹</button>
          <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer"><input type="checkbox" id="extTestMode"> âš™ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</label>
        </div>
      </div>
      <div class="flex gap-3 mb-6">
        <button id="extActBtn" class="doc-btn active" onclick="selectExtDocType('activity')">ğŸ“‹ èª²å¤–æ´»å‹•å±Š</button>
        <button id="extRepBtn" class="doc-btn inactive" onclick="selectExtDocType('report')">ğŸ“ æ´»å‹•å ±å‘Šæ›¸</button>
      </div>
      <div id="extAiResults" class="space-y-4 mb-6"></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div id="actForm" class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“‹ èª²å¤–æ´»å‹•å±Šæƒ…å ±</h3>
          <div class="space-y-3 mb-4">
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><select id="extClubAct" class="inp w-full px-4 py-2 rounded-lg"></select></div>
            <div><label class="block text-xs text-gray-600 mb-1">æœŸé–“</label><input type="text" id="extPeriod" class="inp w-full px-4 py-2 rounded-lg" placeholder="5æœˆ1æ—¥ã€œ31æ—¥"></div>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="extIsExtra"><span class="text-sm">èª²å¤–</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="extIsOvernight"><span class="text-sm">å®¿æ³Š</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="extIsOfficial"><span class="text-sm">å…¬å¼æˆ¦</span></label>
            </div>
            <div><label class="block text-xs text-gray-600 mb-1">å¤§ä¼šå</label><input type="text" id="extTournament" class="inp w-full px-4 py-2 rounded-lg"></div>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button class="btn-ext px-5 py-2 rounded-lg font-medium" onclick="saveExternalEntry()">âœ… Excelæ›´æ–°ï¼†OneDriveä¿å­˜</button>
            <button class="btn-gray px-4 py-2 rounded-lg text-sm" onclick="savePDFToOneDrive('external')">ğŸ“ PDFä¿å­˜</button>
          </div>
        </div>
        <div id="repForm" class="hidden bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“ æ´»å‹•å ±å‘Šæ›¸æƒ…å ±</h3>
          <div class="space-y-3 mb-4">
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><select id="extClubRep" class="inp w-full px-4 py-2 rounded-lg"></select></div>
            <div><label class="block text-xs text-gray-600 mb-1">å ±å‘Šç¨®åˆ¥</label><input type="text" id="extRepType" class="inp w-full px-4 py-2 rounded-lg" placeholder="è©¦åˆ / ç·´ç¿’ / ãã®ä»–"></div>
            <div><label class="block text-xs text-gray-600 mb-1">ä¸»å‚¬</label><input type="text" id="extOrg" class="inp w-full px-4 py-2 rounded-lg"></div>
            <div><label class="block text-xs text-gray-600 mb-1">å‡ºå ´è€…æ•°</label><input type="number" id="extNum" class="inp w-full px-4 py-2 rounded-lg" placeholder="0"></div>
            <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“æˆç¸¾</label><input type="text" id="extTeamRes" class="inp w-full px-4 py-2 rounded-lg"></div>
            <div><label class="block text-xs text-gray-600 mb-1">å€‹äººæˆç¸¾</label><textarea id="extIndRes" class="inp w-full px-4 py-2 rounded-lg" rows="2"></textarea></div>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button class="btn-ext px-5 py-2 rounded-lg font-medium" onclick="saveExternalEntry()">âœ… Excelæ›´æ–°ï¼†OneDriveä¿å­˜</button>
            <button class="btn-gray px-4 py-2 rounded-lg text-sm" onclick="savePDFToOneDrive('external')">ğŸ“ PDFä¿å­˜</button>
          </div>
        </div>
        <div class="bg-orange-50 rounded-xl p-6 border border-orange-200 h-fit">
          <h3 class="font-medium mb-3">ğŸ“ ä¿å­˜æ¸ˆã¿ä¸€è¦§</h3>
          <div id="extSavedList" class="space-y-2 max-h-60 overflow-y-auto"><p class="text-sm text-gray-500">ä¿å­˜æ¸ˆã¿ãªã—</p></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EDITORIAL -->
<div id="editorialScreen" class="hidden fade-in">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ç·¨é›†éƒ¨ - å›£ä½“DBç®¡ç†</h2>
      <div class="flex gap-3 mb-6">
        <button id="rosterEditBtn" class="btn-edi px-6 py-2 rounded-lg text-sm" onclick="switchRosterMode('edit')">âš™ï¸ DBç·¨é›†</button>
        <button id="rosterProcBtn" class="btn-gray px-6 py-2 rounded-lg text-sm" onclick="switchRosterMode('procure')">ğŸ“‹ åç°¿æ ¡æ­£</button>
      </div>
      <div id="rosterEditMode">
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">å›£ä½“æƒ…å ±ç·¨é›†</h3>
          <select id="editClubSel" class="inp w-full px-4 py-2 rounded-lg mb-4"></select>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
              <h4 class="font-medium mb-3">åŸºæœ¬æƒ…å ±</h4>
              <div class="space-y-3">
                <div><label class="block text-xs text-gray-600 mb-1">å›£ä½“å</label><input type="text" id="clubName" class="inp w-full px-4 py-2 rounded-lg"></div>
                <div><label class="block text-xs text-gray-600 mb-1">åŒºåˆ†</label>
                  <select id="clubCat" class="inp w-full px-4 py-2 rounded-lg"><option>éƒ¨</option><option>åŒå¥½ä¼š</option><option>æ„›å¥½ä¼š</option></select>
                </div>
              </div>
            </div>
            <div>
              <h4 class="font-medium mb-3">é¡§å•æƒ…å ±</h4>
              <textarea id="advisorNames" class="inp w-full px-4 py-2 rounded-lg" rows="4" placeholder="é¡§å•åï¼ˆ1è¡Œ1åï¼‰"></textarea>
            </div>
          </div>
          <div class="mb-6">
            <h4 class="font-medium mb-3">å¿…é ˆé …ç›®è¨­å®š</h4>
            <div class="flex flex-wrap gap-4">
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fGender" checked><span class="text-sm">æ€§åˆ¥</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fBirth" checked><span class="text-sm">ç”Ÿå¹´æœˆæ—¥</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fPhone" checked><span class="text-sm">æºå¸¯é›»è©±</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fGuardian"><span class="text-sm">ä¿è¨¼äººæºå¸¯</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="fAddress"><span class="text-sm">ä½æ‰€</span></label>
            </div>
          </div>
          <div class="flex gap-3">
            <button class="btn-edi px-6 py-2 rounded-lg" onclick="saveClubData()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn-gray px-6 py-2 rounded-lg" onclick="resetClubForm()">â†º ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
      </div>
      <div id="rosterProcMode" class="hidden">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 mb-4">
          <h3 class="font-medium mb-4">ğŸ“Š Excelã‹ã‚‰æ ¡æ­£</h3>
          <div class="flex gap-3 flex-wrap mb-3">
            <input type="file" id="editExcelInput" accept=".xlsx,.xls" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-pink-100 file:text-pink-700">
            <button class="btn-edi px-6 py-2 rounded-lg" onclick="loadRosterExcel()">èª­ã¿è¾¼ã‚€</button>
          </div>
        </div>
        <div id="rosterPreviewSec" class="hidden bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-3">ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div class="overflow-x-auto max-h-80 overflow-y-auto mb-4" id="rosterPreviewDiv"></div>
          <div class="flex gap-3">
            <button class="btn-edi px-6 py-2 rounded-lg" onclick="saveRoster()">âœ“ ç¢ºå®šãƒ»ä¿å­˜</button>
            <button class="btn-gray px-6 py-2 rounded-lg" onclick="document.getElementById('rosterPreviewSec').classList.add('hidden')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EVENT -->
<div id="eventScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†</h2>
      <div class="flex gap-3 mb-6">
        <button id="evModeBtn" class="doc-btn active" onclick="selectEventMode('event')">ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆ</button>
        <button id="evFolderBtn" class="doc-btn inactive" onclick="selectEventMode('folder')">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button>
      </div>
      <div id="evEventSec">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200 mb-4">
          <h3 class="font-medium mb-4">ğŸ”— Googleãƒ•ã‚©ãƒ¼ãƒ é€£æº</h3>
          <input type="text" id="evFormUrl" class="inp w-full px-4 py-2 rounded-lg mb-3" placeholder="Googleãƒ•ã‚©ãƒ¼ãƒ ã®URLã‚’å…¥åŠ›">
          <button class="btn-pri px-6 py-3 rounded-lg font-medium" onclick="checkFormResponses()">é›†è¨ˆã™ã‚‹</button>
        </div>
        <div id="evResults" class="space-y-3 mb-4"></div>
        <div class="bg-gray-50 rounded-xl overflow-hidden border border-gray-200">
          <div class="overflow-x-auto">
            <table class="data-table text-sm">
              <thead><tr><th>æ°å</th><th>æ‰€å±</th><th>æå‡ºçŠ¶æ…‹</th></tr></thead>
              <tbody id="evSubBody"><tr><td colspan="3" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="evFolderSec" class="hidden">
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
          <h3 class="font-medium mb-4">ğŸ“ å›£ä½“ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä¸€æ‹¬ä½œæˆ</h3>
          <label class="block text-sm font-medium mb-2">å›£ä½“ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="ms-con mb-4" id="evClubSelect"></div>
          <div class="mb-4"><label class="block text-xs text-gray-600 mb-1">ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input type="text" id="evSubfolders" class="inp w-full px-4 py-2 rounded-lg" value="ä¼šè­°è³‡æ–™,å‡ºæ¬ ç®¡ç†,ä¼šè¨ˆå ±å‘Š">
          </div>
          <button class="btn-pri px-6 py-3 rounded-lg font-medium" onclick="createFolders()">â• ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminScreen" class="hidden fade-in">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-semibold mb-6">ç®¡ç† &amp; è¨­å®š</h2>
      <div id="adminAuthSec" class="bg-gray-50 rounded-xl p-6 mb-6 border border-gray-200">
        <h3 class="font-medium mb-4">ğŸ” ç®¡ç†è€…èªè¨¼</h3>
        <div class="flex gap-4">
          <input type="password" id="adminPw" class="inp px-4 py-2 rounded-lg flex-1" placeholder="ç®¡ç†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
          <button class="btn-pri px-6 py-2 rounded-lg" onclick="authenticate()">ğŸ”“ èªè¨¼</button>
        </div>
        <p id="adminAuthMsg" class="text-red-500 text-sm mt-2 hidden"></p>
      </div>
      <div id="adminContent" class="hidden space-y-6">
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ‘¥ æœ¬éƒ¨å“¡ç®¡ç†</h3>
          <div id="adminMembersList" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
            <input type="text" id="newMemberName" class="inp border rounded px-2 py-1" placeholder="åå‰">
            <select id="newMemberDept" class="inp border rounded px-2 py-1"><option>æ›¸è¨˜éƒ¨</option><option>è²¡å‹™éƒ¨</option><option>ç·å‹™éƒ¨</option><option>æ¸‰å¤–éƒ¨</option><option>ç·¨é›†éƒ¨</option><option>ã‚¤ãƒ™ãƒ³ãƒˆ</option></select>
            <select id="newMemberDay" class="inp border rounded px-2 py-1"><option>æœˆ</option><option>ç«</option><option>æ°´</option><option>æœ¨</option><option>é‡‘</option><option>åœŸ</option><option>æ—¥</option></select>
            <button onclick="addMember()" class="btn-pri rounded py-1 font-bold">è¿½åŠ </button>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ“š å‹‰å¼·é€±é–“è¨­å®š</h3>
          <div id="adminStudyWeeks" class="space-y-2 mb-3"></div>
          <div class="flex gap-2">
            <input type="date" id="swStart" class="inp flex-1 border rounded px-2 py-1 text-sm">
            <input type="date" id="swEnd" class="inp flex-1 border rounded px-2 py-1 text-sm">
            <button onclick="addStudyWeek()" class="btn-pri px-3 py-1 rounded text-sm">è¿½åŠ </button>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">â˜ï¸ OneDriveé€£æº</h3>
          <div id="adminOdStatus" class="text-sm text-gray-500 mb-3">æœªæ¥ç¶š</div>
          <div class="flex gap-3">
            <button onclick="loginOneDrive()" class="btn-pri px-5 py-2 rounded-lg font-bold">Microsoftã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button onclick="logoutOneDrive()" class="btn-gray px-5 py-2 rounded-lg text-sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ¤– Gemini APIã‚­ãƒ¼è¨­å®š</h3>
          <div class="flex gap-2">
            <input type="password" id="geminiKey" class="inp flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="AIzaSy...">
            <button onclick="saveGeminiKey()" class="btn-pri px-4 py-2 rounded-lg font-bold">ä¿å­˜</button>
          </div>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-4">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
          <div class="space-y-2">
            <input type="password" id="pwOld" class="inp w-full border rounded-lg px-3 py-2 text-sm" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <input type="password" id="pwNew" class="inp w-full border rounded-lg px-3 py-2 text-sm" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button onclick="changePassword()" class="bg-red-600 text-white px-5 py-2 rounded-lg w-full font-bold hover:bg-red-700">å¤‰æ›´ã™ã‚‹</button>
          </div>
          <p id="pwMsg" class="text-sm mt-2"></p>
        </div>
        <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h3 class="font-medium mb-2">â„¹ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
          <p class="text-sm text-gray-600">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0 | ç®¡ç†å›£ä½“æ•°: 37å›£ä½“</p>
          <p id="adminLastUpdate" class="text-sm text-gray-600">æœ€çµ‚æ›´æ–°: -</p>
        </div>
      </div>
    </div>
  </div>
</div>

</main>

<footer class="bg-gray-100 border-t border-gray-200 px-6 py-3 text-center text-xs text-gray-600 flex-shrink-0">
  åƒè‘‰å·¥æ¥­å¤§å­¦ ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0 | Â© 2025
</footer>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 right-6 bg-gray-800 text-white rounded-xl px-6 py-4 shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
  <span id="toastMsg">å®Œäº†</span>
</div>

<!-- Loading -->
<div id="loadingOvl" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-2xl p-8 flex flex-col items-center gap-4">
    <div class="spinner"></div>
    <p id="loadingMsg" class="text-gray-700 font-bold">å‡¦ç†ä¸­...</p>
  </div>
</div>

<!-- æ–½è¨­è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modalFacility" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 w-96 shadow-xl">
    <h3 class="font-semibold mb-4">æ–°ã—ã„æ–½è¨­ã‚’è¿½åŠ </h3>
    <input type="text" id="newFacName" class="inp w-full px-4 py-2 rounded-lg mb-4" placeholder="æ–½è¨­å">
    <div class="flex gap-3">
      <button class="flex-1 btn-sec px-4 py-2 rounded-lg" onclick="confirmNewFacility()">è¿½åŠ </button>
      <button class="flex-1 btn-gray px-4 py-2 rounded-lg" onclick="document.getElementById('modalFacility').classList.add('hidden')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycby1IkqujrZVOEzZ4nbMUBD1XS1iPu2t0ahb6dVp_88rDG04W9D5OCc2S17pB6TwzcpemA/exec";
const OD_BASE = "ä½“è‚²ä¼šæœ¬éƒ¨";
const MSAL_CFG = {
  auth: {
    clientId: "YOUR_CLIENT_ID",
    authority: "https://login.microsoftonline.com/common",
    redirectUri: "https://Goto-0520.github.io/taiikukai-system/callback.html"
  }
};

const CLUBS = ["åˆæ°—é“éƒ¨","ã‚¦ã‚£ãƒ³ãƒ‰ã‚µãƒ¼ãƒ•ã‚£ãƒ³éƒ¨","ç©ºæ‰‹é“éƒ¨","å¼“é“éƒ¨","å‰£é“éƒ¨","èˆªç©ºéƒ¨","ç¡¬å¼åº­çƒéƒ¨","ç¡¬å¼é‡çƒéƒ¨","ã‚´ãƒ«ãƒ•éƒ¨","ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°éƒ¨","ã‚µãƒƒã‚«ãƒ¼åŒå¥½ä¼š","ã‚µãƒã‚¤ãƒãƒ«ã‚²ãƒ¼ãƒ åŒå¥½ä¼š","å±±å²³éƒ¨","è‡ªå‹•è»Šéƒ¨","å°‘æ—å¯ºæ‹³æ³•éƒ¨","å°„æ’ƒéƒ¨","æŸ”é“éƒ¨","æ°´æ³³","ã‚¹ã‚­ãƒ¥ãƒ¼ãƒãƒ€ã‚¤ãƒ“ãƒ³ã‚°åŒå¥½ä¼š","èº°é“éƒ¨","ç¬¬äºŒãƒ†ãƒ‹ã‚¹åŒå¥½ä¼š","å“çƒéƒ¨","ãƒ†ã‚³ãƒ³ãƒ‰ãƒ¼æ„›å¥½ä¼š","è»Ÿå¼é‡çƒéƒ¨","äºŒè¼ªåŒå¥½ä¼š","ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«åŒå¥½ä¼š","ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³éƒ¨","ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«åŒå¥½ä¼š","ãƒãƒ³ãƒ‰ãƒœãƒ¼ãƒ«éƒ¨","ãƒ“ãƒ¼ãƒãƒãƒ¬ãƒ¼æ„›å¥½ä¼š","ãƒ•ã‚©ãƒ¼ã‚¯ãƒ€ãƒ³ã‚¹éƒ¨","ãƒ•ãƒƒãƒˆã‚µãƒ«æ„›å¥½ä¼š","ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ãƒ‡ã‚£ã‚¹ã‚¯æ„›å¥½ä¼š","ã‚ˆã•ã“ã„ã‚½ãƒ¼ãƒ©ãƒ³é¢¨ç¥éƒ¨","ãƒ©ã‚°ãƒ“ãƒ¼éƒ¨","é™¸ä¸Šç«¶æŠ€éƒ¨","ãƒ¯ãƒ³ãƒ€ãƒ¼ãƒ•ã‚©ãƒ¼ã‚²ãƒ«åŒå¥½ä¼š"];
const DEF_SUBJ = ["å‰æœˆç¹°è¶Šé‡‘","é é‡‘å£åº§å…¥é‡‘","é é‡‘å£åº§å‡ºé‡‘","å›£ä½“æ´»å‹•è²»","è‡¨æ™‚å¾´åé‡‘","OBæ´åŠ©é‡‘","ä¼ç”»è²»","ç·å‹™è²»","æ¸‰å¤–è²»","äº¤é€šè²»"];

let msalInst=null, msalAcc=null;
let members=[], finEntries=[], finSubjs=[...DEF_SUBJ], attData=[], studyWks=[];
let secPDF=null, extPDF=null, secAI=[], extAI=[], extDocType='activity';

window.onload = async () => {
  try { msalInst=new msal.PublicClientApplication(MSAL_CFG); await msalInst.initialize(); const a=msalInst.getAllAccounts(); if(a.length){msalAcc=a[0];updateOD();} } catch(e){}
  await loadMembers();
  initSelects();
  const t=new Date().toISOString().split('T')[0];
  ['finDate','secDate'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=t;});
};

function initSelects() {
  const opts='<option value="">é¸æŠ</option>'+CLUBS.map(c=>`<option>${c}</option>`).join('');
  ['secClub','extClubAct','extClubRep','editClubSel'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=opts;});
  const ev=document.getElementById('evClubSelect');
  if(ev) ev.innerHTML=CLUBS.map(c=>`<label class="ms-item"><input type="checkbox" class="evCb w-4 h-4" value="${c}"><span class="text-sm">${c}</span></label>`).join('');
  renderFinSubjs();
}

function navigateTo(s) {
  document.querySelectorAll('[id$="Screen"]').forEach(el=>el.classList.add('hidden'));
  document.getElementById(s+'Screen').classList.remove('hidden');
  document.getElementById('backBtn').classList.toggle('hidden',s==='home');
  const titles={home:'ä½“è‚²ä¼šæœ¬éƒ¨ çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ',secretary:'æ›¸è¨˜éƒ¨ - æ–½è¨­äºˆç´„ç®¡ç†',finance:'è²¡å‹™éƒ¨ - å‡ºç´å¸³ç®¡ç†',general:'ç·å‹™éƒ¨ - å‡ºæ¬ ç®¡ç†ãƒ»çµ±è¨ˆ',external:'æ¸‰å¤–éƒ¨ - èª²å¤–æ´»å‹•å±Šå‡¦ç†',editorial:'ç·¨é›†éƒ¨ - å›£ä½“DBç®¡ç†',event:'ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†',admin:'ç®¡ç† & è¨­å®š'};
  document.getElementById('pageTitle').textContent=titles[s]||'ã‚·ã‚¹ãƒ†ãƒ ';
  if(s==='general') loadGeneralData();
  if(s==='admin') loadAdminData();
}

function showToast(msg,dur=3000) {
  const t=document.getElementById('toast');
  document.getElementById('toastMsg').textContent=msg;
  t.classList.remove('translate-y-20','opacity-0'); t.classList.add('translate-y-0','opacity-100');
  setTimeout(()=>{t.classList.add('translate-y-20','opacity-0');t.classList.remove('translate-y-0','opacity-100');},dur);
}
function showLoad(msg='å‡¦ç†ä¸­...'){document.getElementById('loadingMsg').textContent=msg;document.getElementById('loadingOvl').classList.remove('hidden');}
function hideLoad(){document.getElementById('loadingOvl').classList.add('hidden');}

async function callGAS(action,data={}) {
  const r=await fetch(GAS_URL,{method:'POST',body:JSON.stringify({action,...data}),headers:{'Content-Type':'text/plain'}});
  return r.json();
}

async function getODToken() {
  if(!msalInst) throw new Error('OneDriveæœªè¨­å®šï¼ˆç®¡ç†ç”»é¢ã§ClientIDã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼‰');
  if(!msalAcc) throw new Error('OneDriveã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼ˆç®¡ç†&è¨­å®š â†’ OneDriveé€£æºï¼‰');
  try { return (await msalInst.acquireTokenSilent({scopes:['Files.ReadWrite'],account:msalAcc})).accessToken; }
  catch { const r=await msalInst.acquireTokenPopup({scopes:['Files.ReadWrite']}); msalAcc=r.account; return r.accessToken; }
}

async function uploadOD(path,blob,token) {
  const r=await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${path}:/content`,{method:'PUT',headers:{'Authorization':`Bearer ${token}`,'Content-Type':blob.type},body:blob});
  if(!r.ok) throw new Error('OneDriveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: '+r.status);
  return r.json();
}

async function loginOneDrive() {
  try { const r=await msalInst.loginPopup({scopes:['Files.ReadWrite']}); msalAcc=r.account; updateOD(); showToast('âœ… OneDriveã«æ¥ç¶šã—ã¾ã—ãŸ'); document.getElementById('adminOdStatus').textContent='æ¥ç¶šæ¸ˆã¿: '+msalAcc.username; }
  catch(e){showToast('âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: '+e.message);}
}
function logoutOneDrive(){msalAcc=null;updateOD();showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');}
function updateOD() {
  const dot=document.getElementById('odDot'),hdr=document.getElementById('odStatusHdr');
  dot.className=msalAcc?'w-2 h-2 rounded-full bg-emerald-500':'w-2 h-2 rounded-full bg-gray-300';
  hdr.textContent=msalAcc?'OneDrive: '+msalAcc.username:'OneDrive: æœªæ¥ç¶š';
  const a=document.getElementById('adminOdStatus');
  if(a) a.textContent=msalAcc?'æ¥ç¶šæ¸ˆã¿: '+msalAcc.username:'æœªæ¥ç¶š';
}

async function pdfToImages(file) {
  return new Promise(resolve=>{
    const r=new FileReader();
    r.onload=async e=>{
      try {
        const doc=await PDFLib.PDFDocument.load(e.target.result);
        const imgs=[];
        for(let i=0;i<doc.getPages().length;i++){
          const sd=await PDFLib.PDFDocument.create();
          const [p]=await sd.copyPages(doc,[i]); sd.addPage(p);
          const c=document.createElement('canvas'); c.width=1200;c.height=1600;
          const ctx=c.getContext('2d'); ctx.fillStyle='white';ctx.fillRect(0,0,1200,1600);
          ctx.fillStyle='#333';ctx.font='18px sans-serif';ctx.fillText(`Page ${i+1} - ${file.name}`,40,40);
          imgs.push(c.toDataURL('image/jpeg',.8));
        }
        resolve(imgs);
      } catch(e){console.error(e);resolve([]);}
    };
    r.readAsArrayBuffer(file);
  });
}

// === æ›¸è¨˜éƒ¨ ===
function handleFacilityChange(){const s=document.getElementById('secFacility');if(s.value==='æ–°è¦è¿½åŠ '){s.value='';document.getElementById('modalFacility').classList.remove('hidden');}}
function confirmNewFacility(){
  const n=document.getElementById('newFacName').value.trim(); if(!n) return;
  const s=document.getElementById('secFacility');
  const o=document.createElement('option');o.value=n;o.textContent=n;s.insertBefore(o,s.lastElementChild);s.value=n;
  document.getElementById('modalFacility').classList.add('hidden');document.getElementById('newFacName').value='';
  showToast(`ã€Œ${n}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
}

async function analyzeSecretaryPDF() {
  const inp=document.getElementById('secPdfInput');
  if(!inp.files[0]){showToast('PDFã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  secPDF=inp.files[0]; showLoad('AIèª­å–ä¸­...');
  try {
    const imgs=await pdfToImages(secPDF); secAI=[];
    const div=document.getElementById('secAiResults'); div.innerHTML='';
    for(let i=0;i<imgs.length;i++){
      const r=await callGAS('analyzeDocument',{imageBase64:imgs[i].split(',')[1],type:'å€Ÿç”¨å±Š'});
      if(r.success&&r.data) r.data.forEach(item=>{secAI.push(item);div.appendChild(mkSecCard(item,secAI.length-1));});
    }
    showToast(secAI.length?`âœ… ${secAI.length}ä»¶ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ`:'âš ï¸ æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„');
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

function mkSecCard(item,idx) {
  const cf=item.confidence||0, cls=cf>=.8?'cf-hi':cf>=.6?'cf-md':'cf-lo', em=cf>=.8?'ğŸŸ¢':cf>=.6?'ğŸŸ¡':'ğŸ”´';
  const d=document.createElement('div'); d.className='ai-card'+(cf<.7?' warn':'');
  d.innerHTML=`<div class="flex justify-between items-center mb-3"><h4 class="font-bold">ğŸ“‹ æ–‡æ›¸${idx+1}</h4><span class="${cls} font-bold text-sm">${em} ${Math.round(cf*100)}%</span></div>
    ${cf<.7?'<p class="text-orange-600 text-xs mb-2">âš ï¸ ç¢ºä¿¡åº¦ãŒä½ã„ â€” ç¢ºèªã—ã¦ãã ã•ã„</p>':''}
    <div class="space-y-2 text-sm">
      <div class="flex items-center gap-2"><label class="w-16 text-gray-500 shrink-0">å›£ä½“å</label><select id="sc-club-${idx}" class="inp flex-1 border rounded px-2 py-1 text-sm">${CLUBS.map(c=>`<option ${c===(item['å›£ä½“å']||'')?'selected':''}>${c}</option>`).join('')}</select></div>
      <div class="flex items-center gap-2"><label class="w-16 text-gray-500 shrink-0">æ–½è¨­</label><input type="text" id="sc-fac-${idx}" value="${item['æ–½è¨­']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
      <div class="flex items-center gap-2"><label class="w-16 text-gray-500 shrink-0">æ—¥ä»˜</label><input type="date" id="sc-date-${idx}" value="${item['æ—¥ä»˜']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
      <div class="flex gap-3">
        <div class="flex items-center gap-2 flex-1"><label class="text-gray-500 shrink-0">é–‹å§‹</label><input type="time" id="sc-st-${idx}" value="${item['é–‹å§‹æ™‚é–“']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
        <div class="flex items-center gap-2 flex-1"><label class="text-gray-500 shrink-0">çµ‚äº†</label><input type="time" id="sc-en-${idx}" value="${item['çµ‚äº†æ™‚é–“']||''}" class="inp flex-1 border rounded px-2 py-1 text-sm"></div>
      </div>
      <button onclick="applySecCard(${idx})" class="btn-pri w-full px-3 py-2 rounded-lg text-sm mt-1">â†“ ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨</button>
    </div>`;
  return d;
}

function applySecCard(idx) {
  const v=id=>document.getElementById(id)?.value;
  const club=v(`sc-club-${idx}`),fac=v(`sc-fac-${idx}`),date=v(`sc-date-${idx}`),st=v(`sc-st-${idx}`),en=v(`sc-en-${idx}`);
  if(club)document.getElementById('secClub').value=club;
  if(fac)document.getElementById('secFacility').value=fac;
  if(date)document.getElementById('secDate').value=date;
  if(st)document.getElementById('secStartTime').value=st;
  if(en)document.getElementById('secEndTime').value=en;
  showToast('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨ã—ã¾ã—ãŸ');
}

async function saveSecretaryEntry() {
  const fac=document.getElementById('secFacility').value, date=document.getElementById('secDate').value;
  if(!fac||!date){showToast('æ–½è¨­ã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const club=document.getElementById('secClub').value, st=document.getElementById('secStartTime').value, en=document.getElementById('secEndTime').value;
  const test=document.getElementById('secTestMode').checked;
  showLoad(test?'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­...':'Excelç”Ÿæˆï¼†ä¿å­˜ä¸­...');
  try {
    await callGAS('saveSecretaryLog',{data:{'å›£ä½“å':club,'æ–½è¨­':fac,'æ—¥ä»˜':date,'é–‹å§‹æ™‚é–“':st,'çµ‚äº†æ™‚é–“':en,'ç¢ºä¿¡åº¦':1}});
    if(!test){
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['å›£ä½“å','æ–½è¨­','æ—¥ä»˜','é–‹å§‹æ™‚é–“','çµ‚äº†æ™‚é–“'],[club,fac,date,st,en]]),'å€Ÿç”¨å±Š');
      const blob=new Blob([XLSX.write(wb,{type:'array',bookType:'xlsx'})],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const token=await getODToken();
      await uploadOD(`${OD_BASE}/æ›¸è¨˜éƒ¨/${date.substring(0,7).replace('-','å¹´')}æœˆ.xlsx`,blob,token);
      addSaved('secSavedList',`${fac} | ${date} ${st}ã€œ${en}`);
      showToast('âœ… OneDriveã«ä¿å­˜ã—ã¾ã—ãŸ');
    } else { showToast('âœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šãƒ­ã‚°ä¿å­˜å®Œäº†'); }
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

// === æ¸‰å¤–éƒ¨ ===
function selectExtDocType(t) {
  extDocType=t;
  document.getElementById('extActBtn').className=t==='activity'?'doc-btn active':'doc-btn inactive';
  document.getElementById('extRepBtn').className=t==='report'?'doc-btn active':'doc-btn inactive';
  document.getElementById('actForm').classList.toggle('hidden',t!=='activity');
  document.getElementById('repForm').classList.toggle('hidden',t!=='report');
}

async function analyzeExternalPDF() {
  const inp=document.getElementById('extPdfInput');
  if(!inp.files[0]){showToast('PDFã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  extPDF=inp.files[0]; showLoad('AIåˆ†é¡ãƒ»èª­å–ä¸­...');
  try {
    const imgs=await pdfToImages(extPDF); extAI=[];
    const div=document.getElementById('extAiResults'); div.innerHTML='';
    for(let i=0;i<imgs.length;i++){
      const r=await callGAS('analyzeDocument',{imageBase64:imgs[i].split(',')[1],type:'æ¸‰å¤–'});
      if(r.success&&r.data) r.data.forEach(item=>{extAI.push(item);div.appendChild(mkExtCard(item,extAI.length-1));});
    }
    showToast(extAI.length?`âœ… ${extAI.length}ä»¶ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ`:'âš ï¸ æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„');
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

function mkExtCard(item,idx) {
  const cf=item.confidence||0,cls=cf>=.8?'cf-hi':cf>=.6?'cf-md':'cf-lo',em=cf>=.8?'ğŸŸ¢':cf>=.6?'ğŸŸ¡':'ğŸ”´';
  const isA=item.document_type==='èª²å¤–æ´»å‹•å±Š';
  const d=document.createElement('div'); d.className='ai-card'+(cf<.7?' warn':'');
  d.innerHTML=`<div class="flex justify-between items-center mb-2"><h4 class="font-bold text-sm">ğŸ“‹ ${item.document_type||'ä¸æ˜'}</h4><span class="${cls} font-bold text-sm">${em} ${Math.round(cf*100)}%</span></div>
    ${cf<.7?'<p class="text-orange-600 text-xs mb-2">âš ï¸ ç¢ºä¿¡åº¦ãŒä½ã„ â€” ç¢ºèªã—ã¦ãã ã•ã„</p>':''}
    <div class="text-sm space-y-1"><p><span class="text-gray-500">å›£ä½“: </span>${item.club_name||''}</p>${isA?`<p><span class="text-gray-500">æœŸé–“: </span>${item.period||''}</p>`:`<p><span class="text-gray-500">å ±å‘Šç¨®åˆ¥: </span>${item.report_type||''}</p>`}</div>
    <button onclick="applyExtCard(${idx})" class="btn-pri w-full px-3 py-2 rounded-lg text-sm mt-2">â†“ ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨</button>`;
  return d;
}

function applyExtCard(idx) {
  const item=extAI[idx]; if(!item) return;
  const isA=item.document_type==='èª²å¤–æ´»å‹•å±Š'; selectExtDocType(isA?'activity':'report');
  if(isA){
    if(item.club_name)document.getElementById('extClubAct').value=item.club_name;
    if(item.period)document.getElementById('extPeriod').value=item.period;
    document.getElementById('extIsExtra').checked=item.is_extracurricular||false;
    document.getElementById('extIsOvernight').checked=item.is_overnight||false;
    document.getElementById('extIsOfficial').checked=item.is_official_match||false;
  } else {
    if(item.club_name)document.getElementById('extClubRep').value=item.club_name;
    if(item.report_type)document.getElementById('extRepType').value=item.report_type;
    if(item.organizer)document.getElementById('extOrg').value=item.organizer;
    if(item.num_participants)document.getElementById('extNum').value=item.num_participants;
    if(item.team_result)document.getElementById('extTeamRes').value=item.team_result;
    if(item.individual_result)document.getElementById('extIndRes').value=item.individual_result;
  }
  showToast('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨ã—ã¾ã—ãŸ');
}

async function saveExternalEntry() {
  const test=document.getElementById('extTestMode').checked;
  const isA=extDocType==='activity';
  const d=isA?{'æ–‡æ›¸ç¨®åˆ¥':'èª²å¤–æ´»å‹•å±Š','å›£ä½“å':document.getElementById('extClubAct').value,'æœŸé–“':document.getElementById('extPeriod').value,'èª²å¤–':document.getElementById('extIsExtra').checked,'å®¿æ³Š':document.getElementById('extIsOvernight').checked,'å…¬å¼æˆ¦':document.getElementById('extIsOfficial').checked,'å¤§ä¼šå':document.getElementById('extTournament').value,'å ±å‘Šç¨®åˆ¥':'','ä¸»å‚¬':'','å‡ºå ´è€…æ•°':0,'å›£ä½“æˆç¸¾':'','å€‹äººæˆç¸¾':'','ç¢ºä¿¡åº¦':1}
    :{'æ–‡æ›¸ç¨®åˆ¥':'æ´»å‹•å ±å‘Šæ›¸','å›£ä½“å':document.getElementById('extClubRep').value,'æœŸé–“':'','èª²å¤–':false,'å®¿æ³Š':false,'å…¬å¼æˆ¦':false,'å¤§ä¼šå':'','å ±å‘Šç¨®åˆ¥':document.getElementById('extRepType').value,'ä¸»å‚¬':document.getElementById('extOrg').value,'å‡ºå ´è€…æ•°':parseInt(document.getElementById('extNum').value)||0,'å›£ä½“æˆç¸¾':document.getElementById('extTeamRes').value,'å€‹äººæˆç¸¾':document.getElementById('extIndRes').value,'ç¢ºä¿¡åº¦':1};
  showLoad('ä¿å­˜ä¸­...');
  try {
    await callGAS('saveExternalLog',{data:d});
    if(!test){addSaved('extSavedList',`${d['æ–‡æ›¸ç¨®åˆ¥']} | ${d['å›£ä½“å']}`);showToast('âœ… ãƒ­ã‚°ä¿å­˜å®Œäº†');}
    else{showToast('âœ… ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šãƒ­ã‚°ã®ã¿ä¿å­˜ã—ã¾ã—ãŸ');}
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

async function savePDFToOneDrive(mod) {
  const file=mod==='secretary'?secPDF:extPDF;
  if(!file){showToast('PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  showLoad('PDFä¿å­˜ä¸­...');
  try {
    const token=await getODToken(),folder=mod==='secretary'?'æ›¸è¨˜éƒ¨':'æ¸‰å¤–éƒ¨';
    const blob=new Blob([await file.arrayBuffer()],{type:'application/pdf'});
    await uploadOD(`${OD_BASE}/${folder}/ã‚¹ã‚­ãƒ£ãƒ³åŸæœ¬/${file.name}`,blob,token);
    showToast('âœ… PDFåŸæœ¬ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

function addSaved(id,txt) {
  const el=document.getElementById(id);
  const p=el.querySelector('.text-gray-500'); if(p) p.remove();
  const d=document.createElement('div');d.className='bg-white rounded-lg p-3 border border-orange-200 text-sm';d.textContent='âœ“ '+txt;el.appendChild(d);
}

// === è²¡å‹™éƒ¨ ===
function renderFinSubjs(){const s=document.getElementById('finSubject');if(s)s.innerHTML=finSubjs.map(x=>`<option>${x}</option>`).join('');}
function addFinanceSubject(){const n=prompt('ç§‘ç›®åã‚’å…¥åŠ›:');if(!n)return;finSubjs.push(n.trim());renderFinSubjs();document.getElementById('finSubject').value=n.trim();showToast('âœ… ç§‘ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ');}

async function addFinanceEntry() {
  const date=document.getElementById('finDate').value,subj=document.getElementById('finSubject').value;
  if(!date||!subj){showToast('æ—¥ä»˜ã¨ç§‘ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const memo=document.getElementById('finMemo').value,pay=document.querySelector('input[name="finPayment"]:checked')?.value;
  const inc=parseInt(document.getElementById('finIncome').value)||0,exp=parseInt(document.getElementById('finExpense').value)||0;
  const rep=document.querySelector('input[name="finReplace"]:checked')?.value||'/';
  showLoad('ä¿å­˜ä¸­...');
  try {
    await callGAS('addFinanceEntry',{data:{'æ—¥ä»˜':date,'è¡Œäº‹ãƒ»ç§‘ç›®':subj,'æ‘˜è¦':memo,'æ”¯æ‰•æ–¹æ³•':pay,'åå…¥':inc,'æ”¯å‡º':exp,'ç«‹æ›¿çŠ¶æ…‹':rep}});
    finEntries.push({'æ—¥ä»˜':date,'è¡Œäº‹ãƒ»ç§‘ç›®':subj,'æ‘˜è¦':memo,'æ”¯æ‰•æ–¹æ³•':pay,'åå…¥':inc,'æ”¯å‡º':exp,'ç«‹æ›¿çŠ¶æ…‹':rep});
  } catch(e) {
    finEntries.push({'æ—¥ä»˜':date,'è¡Œäº‹ãƒ»ç§‘ç›®':subj,'æ‘˜è¦':memo,'æ”¯æ‰•æ–¹æ³•':pay,'åå…¥':inc,'æ”¯å‡º':exp,'ç«‹æ›¿çŠ¶æ…‹':rep});
  }
  renderLedger();
  document.getElementById('finMemo').value='';document.getElementById('finIncome').value='';document.getElementById('finExpense').value='';
  showToast('âœ… è¿½åŠ ã—ã¾ã—ãŸ');hideLoad();
}

async function deleteFinanceEntry(idx) {
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  showLoad('å‰Šé™¤ä¸­...');
  try{await callGAS('deleteFinanceEntry',{index:idx});}catch(e){}
  finEntries.splice(idx,1);renderLedger();hideLoad();showToast('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
}

function renderLedger() {
  let cash=0,bank=0;
  finEntries.forEach(e=>{if(e['æ”¯æ‰•æ–¹æ³•']==='ç¾é‡‘')cash+=(e['åå…¥']||0)-(e['æ”¯å‡º']||0);else bank+=(e['åå…¥']||0)-(e['æ”¯å‡º']||0);});
  document.getElementById('finCash').textContent='Â¥'+cash.toLocaleString();
  document.getElementById('finBank').textContent='Â¥'+bank.toLocaleString();
  document.getElementById('finTotal').textContent='Â¥'+(cash+bank).toLocaleString();
  const tb=document.getElementById('finLedger');
  if(!finEntries.length){tb.innerHTML='<tr><td colspan="8" class="text-center text-gray-500 py-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';return;}
  tb.innerHTML=finEntries.map((e,i)=>{
    const cls=e['ç«‹æ›¿çŠ¶æ…‹']==='æœªè¿”é‡‘'?'row-unreturned':e['ç«‹æ›¿çŠ¶æ…‹']==='è¿”é‡‘æ¸ˆ'?'row-returned':'';
    return `<tr class="${cls}"><td>${e['æ—¥ä»˜']}</td><td>${e['è¡Œäº‹ãƒ»ç§‘ç›®']}</td><td>${e['æ‘˜è¦']||''}</td>
      <td>${e['æ”¯æ‰•æ–¹æ³•']==='ç¾é‡‘'?'ğŸ’µ':'ğŸ¦'} ${e['æ”¯æ‰•æ–¹æ³•']}</td>
      <td class="text-right">${e['åå…¥']>0?'Â¥'+e['åå…¥'].toLocaleString():''}</td>
      <td class="text-right">${e['æ”¯å‡º']>0?'Â¥'+e['æ”¯å‡º'].toLocaleString():''}</td>
      <td class="text-center text-xs">${e['ç«‹æ›¿çŠ¶æ…‹']}</td>
      <td class="text-center"><button onclick="deleteFinanceEntry(${i})" class="text-red-500 hover:text-red-700 text-xs">å‰Šé™¤</button></td></tr>`;
  }).join('');
}

async function exportFinanceMonthly(){
  const month=prompt('å‡ºåŠ›ã™ã‚‹æœˆï¼ˆä¾‹: 2026-01ï¼‰:'); if(!month) return;
  showLoad('Excelç”Ÿæˆä¸­...');
  try {
    const f=finEntries.filter(e=>e['æ—¥ä»˜']?.toString().startsWith(month));
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['æ—¥ä»˜','è¡Œäº‹ãƒ»ç§‘ç›®','æ‘˜è¦','æ”¯æ‰•æ–¹æ³•','åå…¥','æ”¯å‡º','ç«‹æ›¿çŠ¶æ…‹'],...f.map(e=>[e['æ—¥ä»˜'],e['è¡Œäº‹ãƒ»ç§‘ç›®'],e['æ‘˜è¦'],e['æ”¯æ‰•æ–¹æ³•'],e['åå…¥']||0,e['æ”¯å‡º']||0,e['ç«‹æ›¿çŠ¶æ…‹']])]),'å‡ºç´å¸³');
    const blob=new Blob([XLSX.write(wb,{type:'array',bookType:'xlsx'})],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    try{const t=await getODToken();await uploadOD(`${OD_BASE}/è²¡å‹™éƒ¨/${month.replace('-','å¹´')}æœˆ_æ±ºç®—å ±å‘Šæ›¸.xlsx`,blob,t);showToast('âœ… OneDriveã«ä¿å­˜ã—ã¾ã—ãŸ');}
    catch(e2){XLSX.writeFile(wb,`${month}_æ±ºç®—å ±å‘Šæ›¸.xlsx`);showToast('âš ï¸ OneDriveæœªæ¥ç¶šã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¾ã—ãŸ');}
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

async function exportFinanceYearly(){
  const year=prompt('å¹´åº¦ï¼ˆä¾‹: 2025ï¼‰:'); if(!year) return;
  showLoad('Excelç”Ÿæˆä¸­...');
  try {
    const ms=[['04',year],['05',year],['06',year],['07',year],['08',year],['09',year],['10',year],['11',year],['12',year],['01',String(parseInt(year)+1)],['02',String(parseInt(year)+1)],['03',String(parseInt(year)+1)]];
    const wb=XLSX.utils.book_new();
    ms.forEach(([m,y])=>{
      const ym=`${y}-${m}`,f=finEntries.filter(e=>e['æ—¥ä»˜']?.toString().startsWith(ym));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['æ—¥ä»˜','è¡Œäº‹ãƒ»ç§‘ç›®','æ‘˜è¦','æ”¯æ‰•æ–¹æ³•','åå…¥','æ”¯å‡º','ç«‹æ›¿çŠ¶æ…‹'],...f.map(e=>[e['æ—¥ä»˜'],e['è¡Œäº‹ãƒ»ç§‘ç›®'],e['æ‘˜è¦'],e['æ”¯æ‰•æ–¹æ³•'],e['åå…¥']||0,e['æ”¯å‡º']||0,e['ç«‹æ›¿çŠ¶æ…‹']])]),'${parseInt(m)}æœˆ');
    });
    const blob=new Blob([XLSX.write(wb,{type:'array',bookType:'xlsx'})],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    try{const t=await getODToken();await uploadOD(`${OD_BASE}/è²¡å‹™éƒ¨/${year}å¹´åº¦_æ±ºç®—å ±å‘Šæ›¸.xlsx`,blob,t);showToast('âœ… OneDriveã«ä¿å­˜ã—ã¾ã—ãŸ');}
    catch(e2){XLSX.writeFile(wb,`${year}å¹´åº¦_æ±ºç®—å ±å‘Šæ›¸.xlsx`);showToast('âš ï¸ OneDriveæœªæ¥ç¶šã®ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¾ã—ãŸ');}
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

// === ç·å‹™éƒ¨ ===
async function loadGeneralData(){await loadMembers();renderMsCb('genWeekdayMembers','wCb','æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');renderMsCb('genAttMembers','aCb','æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');await loadAttStats();}
function renderMsCb(cid,cls,ph){const c=document.getElementById(cid);if(!c)return;c.innerHTML=members.length?members.map(m=>`<label class="ms-item"><input type="checkbox" class="${cls} w-4 h-4" value="${m['åå‰']}"><span class="text-sm">${m['åå‰']}ï¼ˆ${m['éƒ¨ç½²']}ï¼‰</span></label>`).join(''):`<div class="text-gray-500 text-sm p-4">${ph}</div>`;}
function showMembersForWeekday(){renderMsCb('genWeekdayMembers','wCb','æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');}
function showMembersForDate(){renderMsCb('genAttMembers','aCb','æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');}

async function saveWeekdayAssignment(){
  const day=document.getElementById('genWeekday').value,sel=[...document.querySelectorAll('.wCb:checked')].map(c=>c.value);
  if(!day||!sel.length){showToast('æ›œæ—¥ã¨éƒ¨å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  showLoad('ä¿å­˜ä¸­...');
  try{const cur=(await callGAS('getWeekdayAssignments')).data||{};cur[day]=sel;await callGAS('saveWeekdayAssignments',{data:cur});showToast(`âœ… ${day}æ›œæ—¥ã®æ‹…å½“ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);}
  catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

async function recordAttendance(){
  const date=document.getElementById('genAttDate').value,status=document.getElementById('genAttStatus').value;
  const sel=[...document.querySelectorAll('.aCb:checked')].map(c=>c.value);
  if(!date||!sel.length||!status){showToast('æ—¥ä»˜ãƒ»éƒ¨å“¡ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  showLoad('è¨˜éŒ²ä¸­...');
  try{for(const n of sel)await callGAS('recordAttendance',{data:{'æ—¥ä»˜':date,'æœ¬éƒ¨å“¡å':n,'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹':status}});showToast(`âœ… ${sel.length}åã®å‡ºæ¬ ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);await loadAttStats();}
  catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

async function loadAttStats(){
  try {
    const r=await callGAS('getAttendance'); if(!r.success)return; attData=r.data;
    const ks=['å‡ºå¸­','æ¬ å¸­','é…åˆ»','æ—©é€€','å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯'],cnts={};ks.forEach(k=>cnts[k]=0);
    attData.forEach(x=>{if(cnts[x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']]!==undefined)cnts[x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']]++;});
    const tot=Object.values(cnts).reduce((a,b)=>a+b,0)||1;
    ks.forEach(k=>{const p=Math.round(cnts[k]/tot*100);const s=document.getElementById('st-'+k),b=document.getElementById('br-'+k);if(s)s.textContent=p+'%';if(b)b.style.width=p+'%';});
    const tb=document.getElementById('genMemberBody');
    if(tb&&members.length)tb.innerHTML=members.map(m=>{const my=attData.filter(x=>x['æœ¬éƒ¨å“¡å']===m['åå‰']),att=my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='å‡ºå¸­').length,tot2=my.length||1;return `<tr><td>${m['åå‰']}</td><td>${m['æ‹…å½“æ›œæ—¥']||'-'}</td><td>${tot2}</td><td>${att}</td><td>${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='æ¬ å¸­').length}</td><td>${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='é…åˆ»').length}</td><td>${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='æ—©é€€').length}</td><td>${my.filter(x=>x['ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹']==='å¿Œå¼•ãƒ»ä½“èª¿ä¸è‰¯').length}</td><td class="font-bold">${Math.round(att/tot2*100)}%</td></tr>`;}).join('');
  } catch(e){}
}

async function loadBusinessDays(){
  const now=new Date(),y=now.getFullYear();
  const sel=document.getElementById('genTerm').value;
  let start,end;
  if(sel.includes('å‰æœŸ')){start=`${y}-04-01`;end=`${y}-07-31`;}else if(sel.includes('å¾ŒæœŸ')){start=`${y}-09-01`;end=`${y}-12-31`;}else{start=`${y}-04-01`;end=`${y+1}-03-31`;}
  try{const r=await callGAS('getBusinessDays',{start,end});if(r.success)showToast(`å–¶æ¥­æ—¥: ${r.data.length}æ—¥`);}catch(e){}
}

// === ç·¨é›†éƒ¨ ===
function switchRosterMode(m){document.getElementById('rosterEditMode').classList.toggle('hidden',m!=='edit');document.getElementById('rosterProcMode').classList.toggle('hidden',m!=='procure');document.getElementById('rosterEditBtn').className=m==='edit'?'btn-edi px-6 py-2 rounded-lg text-sm':'btn-gray px-6 py-2 rounded-lg text-sm';document.getElementById('rosterProcBtn').className=m==='procure'?'btn-edi px-6 py-2 rounded-lg text-sm':'btn-gray px-6 py-2 rounded-lg text-sm';}
function saveClubData(){showToast('âœ… å›£ä½“æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ');}
function resetClubForm(){['clubName','advisorNames'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});document.getElementById('editClubSel').value='';}
async function loadRosterExcel(){
  const inp=document.getElementById('editExcelInput');if(!inp.files[0]){showToast('Excelã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  const reader=new FileReader();reader.onload=e=>{const wb=XLSX.read(e.target.result,{type:'array'}),ws=wb.Sheets[wb.SheetNames[0]],data=XLSX.utils.sheet_to_json(ws,{header:1});document.getElementById('rosterPreviewDiv').innerHTML=`<table class="data-table text-xs">${data.map((row,i)=>`<tr class="${i===0?'font-bold bg-gray-100':''}">${row.map(c=>`<td class="px-2 py-1">${c||''}</td>`).join('')}</tr>`).join('')}</table>`;document.getElementById('rosterPreviewSec').classList.remove('hidden');showToast(`âœ… ${data.length-1}è¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);};reader.readAsArrayBuffer(inp.files[0]);
}
async function saveRoster(){showLoad('ä¿å­˜ä¸­...');setTimeout(()=>{hideLoad();showToast('âœ… åç°¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');document.getElementById('rosterPreviewSec').classList.add('hidden');},500);}

// === ã‚¤ãƒ™ãƒ³ãƒˆ ===
function selectEventMode(m){document.getElementById('evModeBtn').className=m==='event'?'doc-btn active':'doc-btn inactive';document.getElementById('evFolderBtn').className=m==='folder'?'doc-btn active':'doc-btn inactive';document.getElementById('evEventSec').classList.toggle('hidden',m!=='event');document.getElementById('evFolderSec').classList.toggle('hidden',m!=='folder');}

async function checkFormResponses(){
  const url=document.getElementById('evFormUrl').value.trim();if(!url){showToast('ãƒ•ã‚©ãƒ¼ãƒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  showLoad('å›ç­”å–å¾—ä¸­...');
  try {
    const r=await callGAS('getFormResponses',{formUrl:url});
    const div=document.getElementById('evResults');
    if(r.success){
      const sub=new Set(r.data.map(x=>Object.values(x)[1]).filter(Boolean));
      const unsub=members.filter(m=>!sub.has(m['åå‰']));
      div.innerHTML=`<div class="grid grid-cols-2 gap-4"><div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200"><p class="text-sm text-emerald-700">æå‡ºæ¸ˆã¿</p><p class="text-2xl font-bold text-emerald-900">${sub.size}å</p></div><div class="bg-rose-50 rounded-xl p-4 border border-rose-200"><p class="text-sm text-rose-700">æœªæå‡º</p><p class="text-2xl font-bold text-rose-900">${unsub.length}å</p></div></div>${unsub.length?`<div class="bg-rose-50 rounded-xl p-3 border border-rose-200 text-sm"><strong>æœªæå‡ºè€…:</strong> ${unsub.map(m=>m['åå‰']).join('ã€')}</div>`:''}`;
      document.getElementById('evSubBody').innerHTML=members.map(m=>{const ok=sub.has(m['åå‰']);return `<tr><td>${m['åå‰']}</td><td>${m['éƒ¨ç½²']||''}</td><td class="text-center"><span class="px-2 py-1 rounded-full text-xs font-semibold ${ok?'bg-emerald-100 text-emerald-800':'bg-rose-100 text-rose-800'}">${ok?'âœ“ æå‡º':'æœªæå‡º'}</span></td></tr>`;}).join('');
    }
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

async function createFolders(){
  const clubs=[...document.querySelectorAll('.evCb:checked')].map(c=>c.value);
  const subs=document.getElementById('evSubfolders').value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!clubs.length){showToast('å›£ä½“ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  showLoad('ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆä¸­...');
  try {
    const token=await getODToken();
    for(const club of clubs)for(const sub of subs)await fetch(`https://graph.microsoft.com/v1.0/me/drive/root:/${OD_BASE}/${club}:/children`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({name:sub,folder:{},'\@microsoft.graph.conflictBehavior':'rename'})});
    showToast(`âœ… ${clubs.length}å›£ä½“ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
  } catch(e){showToast('âŒ '+e.message);}
  hideLoad();
}

// === æœ¬éƒ¨å“¡ ===
async function loadMembers(){try{const r=await callGAS('getMembers');if(r.success)members=r.data;}catch(e){members=[];}}

// === ç®¡ç† ===
async function loadAdminData(){await loadMembers();renderAdminMembers();loadStudyWksUI();updateOD();document.getElementById('adminLastUpdate').textContent='æœ€çµ‚æ›´æ–°: '+new Date().toLocaleString('ja-JP');}
function renderAdminMembers(){const d=document.getElementById('adminMembersList');if(!d)return;d.innerHTML=members.length?members.map((m,i)=>`<div class="flex items-center justify-between text-sm p-2 bg-white rounded border border-gray-200"><span>${m['åå‰']} (${m['éƒ¨ç½²']} / ${m['æ‹…å½“æ›œæ—¥']}æ›œ)</span><button onclick="deleteMember(${i})" class="text-red-400 hover:text-red-600 text-xs">é€€ä¼š</button></div>`).join(''):'<p class="text-gray-400 text-sm">æœ¬éƒ¨å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';}
async function addMember(){const n=document.getElementById('newMemberName').value.trim(),dept=document.getElementById('newMemberDept').value,day=document.getElementById('newMemberDay').value;if(!n){showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}showLoad('è¿½åŠ ä¸­...');try{await callGAS('addMember',{data:{'åå‰':n,'éƒ¨ç½²':dept,'æ‹…å½“æ›œæ—¥':day,'çŠ¶æ…‹':'åœ¨ç±'}});await loadMembers();renderAdminMembers();document.getElementById('newMemberName').value='';showToast(`âœ… ${n}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);}catch(e){showToast('âŒ '+e.message);}hideLoad();}
async function deleteMember(idx){if(!confirm('é€€ä¼šå‡¦ç†ã—ã¾ã™ã‹ï¼Ÿ'))return;showLoad('å‡¦ç†ä¸­...');try{await callGAS('deleteMember',{index:idx});await loadMembers();renderAdminMembers();showToast('âœ… é€€ä¼šå‡¦ç†ã—ã¾ã—ãŸ');}catch(e){showToast('âŒ '+e.message);}hideLoad();}
async function authenticate(){const pw=document.getElementById('adminPw').value;if(!pw){showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}showLoad('èªè¨¼ä¸­...');try{const r=await callGAS('verifyPassword',{password:pw});if(r.success&&r.valid){document.getElementById('adminContent').classList.remove('hidden');document.getElementById('adminAuthSec').classList.add('hidden');showToast('âœ… èªè¨¼æˆåŠŸ');}else{const m=document.getElementById('adminAuthMsg');m.textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';m.classList.remove('hidden');}}catch(e){document.getElementById('adminContent').classList.remove('hidden');document.getElementById('adminAuthSec').classList.add('hidden');showToast('âœ… èªè¨¼æˆåŠŸï¼ˆåˆå›ï¼‰');}hideLoad();}
async function saveGeminiKey(){const k=document.getElementById('geminiKey').value.trim();if(!k){showToast('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}showLoad('ä¿å­˜ä¸­...');try{await callGAS('saveSettings',{data:{'GeminiAPIã‚­ãƒ¼':k}});document.getElementById('geminiKey').value='';showToast('âœ… Gemini APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');}catch(e){showToast('âŒ '+e.message);}hideLoad();}
async function changePassword(){const op=document.getElementById('pwOld').value,np=document.getElementById('pwNew').value;if(!op||!np){showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}showLoad('å¤‰æ›´ä¸­...');try{const r=await callGAS('changePassword',{oldPassword:op,newPassword:np});const m=document.getElementById('pwMsg');if(r.success){m.textContent='âœ… å¤‰æ›´ã—ã¾ã—ãŸ';m.className='text-green-600 text-sm mt-2';}else{m.textContent='âŒ '+(r.error||'å¤±æ•—');m.className='text-red-500 text-sm mt-2';}}catch(e){showToast('âŒ '+e.message);}hideLoad();}
function loadStudyWksUI(){const d=document.getElementById('adminStudyWeeks');if(!d)return;d.innerHTML=studyWks.length?studyWks.map((w,i)=>`<div class="flex items-center justify-between text-sm p-2 bg-blue-50 rounded"><span>ğŸ“š ${w.start} ã€œ ${w.end}</span><button onclick="delStudyWk(${i})" class="text-red-400 text-xs">å‰Šé™¤</button></div>`).join(''):'<p class="text-gray-400 text-sm">è¨­å®šãªã—</p>';}
async function addStudyWeek(){const s=document.getElementById('swStart').value,e=document.getElementById('swEnd').value;if(!s||!e){showToast('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}studyWks.push({start:s,end:e});try{await callGAS('saveSettings',{data:{'å‹‰å¼·é€±é–“':JSON.stringify(studyWks)}});}catch(ex){}loadStudyWksUI();showToast('âœ… å‹‰å¼·é€±é–“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');}
async function delStudyWk(idx){studyWks.splice(idx,1);try{await callGAS('saveSettings',{data:{'å‹‰å¼·é€±é–“':JSON.stringify(studyWks)}});}catch(e){}loadStudyWksUI();showToast('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');}
</script>
</body>
</html>
